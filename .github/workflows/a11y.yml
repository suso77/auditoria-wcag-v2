name: ‚ôø Auditor√≠a de Accesibilidad ‚Äì a11y CI

on:
  workflow_dispatch:
    inputs:
      site_url:
        description: "URL base del sitio a auditar"
        required: false
        default: "https://www.hiexperience.es"
  push:
    branches: [ main, master, principal ]
  pull_request:

jobs:
  a11y:
    runs-on: ubuntu-latest

    env:
      SITE_URL: ${{ github.event.inputs.site_url || 'https://www.hiexperience.es' }}
      LC_ALL: C.UTF-8
      LANG: C.UTF-8
      CRITICAL_MAX: 0
      SERIOUS_MAX: 5

    steps:
      # 1Ô∏è‚É£ Clonar el repositorio
      - name: üß© Checkout del repositorio
        uses: actions/checkout@v4

      # 2Ô∏è‚É£ Configurar Node.js
      - name: ‚öôÔ∏è Configurar Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: '**/package-lock.json'

      # 3Ô∏è‚É£ Instalar dependencias limpias
      - name: üì¶ Instalar dependencias
        run: |
          echo "üßπ Limpiando entorno previo..."
          rm -rf node_modules package-lock.json
          echo "üì¶ Instalando dependencias..."
          npm install --no-audit --no-fund

      # 4Ô∏è‚É£ Rastreo de URLs con Puppeteer
      - name: üåê Rastreo de URLs
        run: |
          echo "==============================================="
          echo "üåç INICIO DEL RASTREO DE URLs"
          echo "==============================================="
          echo "üîó Sitio: $SITE_URL"
          echo ""
          npm run crawl:js
          echo ""
          echo "‚úÖ Rastreo completado correctamente"
          echo "üìÅ Archivo generado: scripts/urls.json"
          echo "==============================================="
        env:
          SITE_URL: ${{ env.SITE_URL }}

      # 5Ô∏è‚É£ Auditor√≠a con Cypress + axe-core
      - name: ‚ôø Ejecutar auditor√≠a de accesibilidad
        uses: cypress-io/github-action@v6
        with:
          install-command: npm ci
          command: npm run auditoria || echo "‚ö†Ô∏è Violaciones detectadas (continuamos para generar informes)..."
        env:
          SITE_URL: ${{ env.SITE_URL }}

      # 6Ô∏è‚É£ Combinar resultados (results.json ‚Üí merged)
      - name: üß© Combinar resultados de auditor√≠a
        run: |
          echo "üîÑ Combinando resultados..."
          npm run merge || npm run fix
          echo "‚úÖ Archivo combinado creado correctamente."

      # üß™ Validar archivo combinado antes del informe
      - name: üîç Validar integridad del archivo combinado
        run: |
          echo "üîé Verificando contenido de auditorias/results-merged-*.json ..."
          FILE=$(ls auditorias/results-merged-*.json 2>/dev/null | tail -n 1 || true)
          if [ -z "$FILE" ]; then
            echo "‚ùå No se encontr√≥ ning√∫n results-merged.json. Intentando fusionar..."
            npm run merge || npm run fix
          else
            if [ ! -s "$FILE" ]; then
              echo "‚ö†Ô∏è Archivo combinado vac√≠o. Intentando reparar..."
              npm run fix
            else
              echo "‚úÖ Archivo v√°lido detectado: $FILE"
            fi
          fi

      # 7Ô∏è‚É£ Generar informe Excel + ZIP con evidencias
      - name: üìä Generar informe Excel y ZIP
        run: |
          echo "üìÑ Generando informe profesional..."
          npm run report || exit 1
          echo "‚úÖ Informe Excel y ZIP generados correctamente."

      # 8Ô∏è‚É£ Control de calidad (Quality Gate)
      - name: üö¶ Control de calidad ‚Äì WCAG (Quality Gate)
        run: |
          echo "==============================================="
          echo "üö¶ INICIO DEL CONTROL DE CALIDAD"
          echo "==============================================="
          npm run quality || echo "‚ö†Ô∏è Violaciones fuera de umbrales (modo auditor√≠a continua)"
          echo ""
          echo "‚úÖ FIN DEL CONTROL DE CALIDAD"
          echo "==============================================="
        continue-on-error: true

      # 9Ô∏è‚É£ Subir artefactos finales (Excel + ZIP + evidencias)
      - name: üì§ Subir artefactos finales
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: Auditor√≠a-WCAG-${{ github.run_number }}
          path: |
            auditorias/Informe-*.xlsx
            auditorias/Informe-WCAG-*.zip
            auditorias/*-evidencias/**
          retention-days: 30

      # üîü Resumen final
      - name: ‚úÖ Resumen de ejecuci√≥n
        if: always()
        run: |
          echo "==============================================="
          echo "‚ôø RESUMEN FINAL DE LA AUDITOR√çA DE ACCESIBILIDAD"
          echo "==============================================="
          echo "üåç Sitio auditado: $SITE_URL"
          echo "üìä Informe Excel y ZIP subidos como artefactos"
          echo "üö¶ Umbrales Quality Gate: Critical <= $CRITICAL_MAX, Serious <= $SERIOUS_MAX"
          echo "‚úÖ Auditor√≠a finalizada correctamente."
