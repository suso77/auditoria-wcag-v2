name: ‚ôø Auditor√≠a de Accesibilidad ‚Äì Il√∫mina Audit IAAP PRO
run-name: "‚ôø Auditor√≠a WCAG (${{ github.event.inputs.site_url || 'default' }})"

on:
  workflow_dispatch:
    inputs:
      site_url:
        description: "URL base del sitio a auditar"
        required: false
        default: "https://www.hiexperience.es"
  push:
    branches: [ main, master, principal ]
  pull_request:

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  a11y:
    runs-on: ubuntu-latest
    timeout-minutes: 90
    defaults:
      run:
        working-directory: ${{ github.workspace }}

    env:
      SITE_URL: ${{ github.event.inputs.site_url || vars.SITE_URL || 'https://www.hiexperience.es' }}
      LC_ALL: C.UTF-8
      LANG: C.UTF-8
      TZ: Europe/Madrid
      NODE_ENV: production
      NODE_OPTIONS: "--max-old-space-size=4096 --experimental-specifier-resolution=node --no-warnings"
      TS_NODE_TRANSPILE_ONLY: true
      TS_NODE_PROJECT: tsconfig.json
      TS_NODE_COMPILER_OPTIONS: '{"module":"esnext"}'
      CRITICAL_MAX: 5
      SERIOUS_MAX: 20
      PUPPETEER_EXECUTABLE_PATH: "/usr/bin/google-chrome-stable"
      CYPRESS_screenshotsFolder: auditorias/capturas
      CYPRESS_video: false
      CYPRESS_screenshotOnRunFailure: true

    steps:
      # =====================================================
      # üß© Setup base
      # =====================================================
      - name: üß© Checkout del repositorio
        uses: actions/checkout@v4

      - name: ‚öôÔ∏è Configurar Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          check-latest: true
          cache: "npm"
          cache-dependency-path: "**/package-lock.json"

      - name: üß† Cachear dependencias pesadas
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/Cypress
            ~/.cache/puppeteer
          key: ${{ runner.os }}-a11y-${{ hashFiles('package-lock.json', 'cypress.config.*') }}

      - name: üßπ Limpiar resultados anteriores
        run: |
          rm -rf auditorias/* || true
          mkdir -p auditorias/capturas auditorias/logs scripts

      - name: üß© Ajustar permisos
        run: sudo chmod -R 777 auditorias scripts

      - name: üì¶ Instalar dependencias
        run: |
          npm ci --include=dev
          npm rebuild
          if [ ! -f scripts/urls.json ]; then echo "[]" > scripts/urls.json; fi

      - name: üß© Instalar ts-node y TypeScript (fallback)
        run: |
          if ! npx ts-node --version >/dev/null 2>&1; then
            npm install --no-save ts-node typescript @types/node
          fi

      - name: üß™ Verificar instalaci√≥n de Cypress
        run: |
          if ! npx cypress --version >/dev/null 2>&1; then
            npm install cypress --no-save
          fi
          npx cypress verify || npx cypress install

      # =====================================================
      # üßæ Validaciones previas
      # =====================================================
      - name: üßæ Validar entorno base
        run: node scripts/check-env.cjs

      - name: üîç Validar listado de URLs inicial
        run: node scripts/validate-urls.mjs || echo "‚ö†Ô∏è Se generar√° m√°s adelante"

      - name: üåê Rastreo del sitio
        timeout-minutes: 15
        run: |
          echo "::group::üåç Rastreo en $SITE_URL"
          npm run crawl:js || echo "‚ö†Ô∏è Rastreo no disponible"
          node scripts/validate-urls.mjs || echo "‚ö†Ô∏è Validaci√≥n no cr√≠tica"
          echo "::endgroup::"

      - name: üß© Estado del sistema
        run: |
          echo "Memoria usada:"
          free -h || true
          echo "Espacio disponible:"
          df -h || true

      # ‚úÖ Fallback adicional
      - name: üîß Fallback de URLs
        run: |
          if [ ! -s scripts/urls.json ]; then
            echo "‚ö†Ô∏è Generando urls.json vac√≠o (no cr√≠tico)"
            echo "[]" > scripts/urls.json
          fi

      # =====================================================
      # ‚ôø Auditor√≠as principales
      # =====================================================
      - name: üß± Preparar carpetas de salida
        run: |
          mkdir -p auditorias/capturas auditorias/auditoria-sitemap auditorias/auditoria-interactiva scripts

      - name: ‚ôø Auditor√≠a de accesibilidad ‚Äì Sitemap
        uses: cypress-io/github-action@v6
        continue-on-error: true
        with:
          install-command: npm ci --include=dev
          command: >
            npx cypress run --browser chrome --headless
            --config-file cypress.config.cjs
            --spec cypress/e2e/accesibilidad-sitemap.cy.js

      - name: üß† Auditor√≠a de accesibilidad ‚Äì Componentes interactivos
        uses: cypress-io/github-action@v6
        continue-on-error: true
        with:
          install-command: npm ci --include=dev
          command: >
            npx cypress run --browser chrome --headless
            --config-file cypress.config.cjs
            --spec cypress/e2e/accesibilidad-interactiva.cy.js

      - name: üè∑Ô∏è A√±adir campo "origen"
        run: node scripts/tag-origen.cjs || echo "‚ÑπÔ∏è Campo origen no necesario"

      # =====================================================
      # üß© Combinaci√≥n + resumen + quality
      # =====================================================
      - name: üß© Combinar resultados (merge-results.mjs)
        run: |
          node scripts/merge-results.mjs || echo "‚ö†Ô∏è No hay resultados v√°lidos para combinar."
          if [ -z "$(ls auditorias/results-merged-*.json 2>/dev/null)" ]; then
            echo "[]" > auditorias/results-merged-placeholder.json
            echo "‚ö†Ô∏è Placeholder generado."
          fi

      - name: üßæ Generar resumen ejecutivo (Markdown)
        run: |
          if ls auditorias/results-merged-*.json >/dev/null 2>&1; then
            node scripts/generate-summary.mjs $(ls -t auditorias/results-merged-*.json | head -n1) \
              > auditorias/Resumen-WCAG.md
          else
            echo "‚ö†Ô∏è No se gener√≥ resumen."
          fi

      - name: üö¶ Quality Gate ‚Äì WCAG
        continue-on-error: true
        run: npm run quality || echo "‚ö†Ô∏è Quality Gate con advertencias."

      # =====================================================
      # üìä Exportaciones IAAP
      # =====================================================
      - name: üìä Exportar informe Excel IAAP
        run: node scripts/export-to-xlsx.mjs || echo "‚ö†Ô∏è Error no cr√≠tico exportando Excel."

      - name: üñ®Ô∏è Generar PDF IAAP profesional
        run: node scripts/generate-report.mjs || echo "‚ö†Ô∏è Error no cr√≠tico generando PDF."
        env:
          PUPPETEER_EXECUTABLE_PATH: /usr/bin/google-chrome-stable

      - name: üì∏ Generar evidencias visuales
        if: always()
        run: |
          if [ -f scripts/capture-evidence.mjs ]; then
            node scripts/capture-evidence.mjs || echo "‚ö†Ô∏è Capturas no generadas."
          else
            echo "‚ÑπÔ∏è No hay script de capturas."
          fi

      - name: üì¶ Generar ZIP consolidado
        run: |
          zip -r auditorias/Informe-WCAG-IAAP.zip auditorias/*.xlsx auditorias/*.pdf auditorias/*.md auditorias/results-merged-*.json || echo "‚ö†Ô∏è ZIP no generado"

      # =====================================================
      # üåê Publicaci√≥n Dashboard + Hist√≥rico
      # =====================================================
      - name: üß± Preparar carpeta p√∫blica
        run: |
          set +e
          FECHA=$(date +'%Y-%m-%d_%H-%M-%S')
          mkdir -p public/auditorias/${FECHA}

          echo "üßæ Copiando archivos disponibles..."
          [ -f auditorias/Informe-WCAG-IAAP.pdf ] && cp auditorias/Informe-WCAG-IAAP.pdf public/auditorias/${FECHA}/ || echo "‚ö†Ô∏è PDF no encontrado."
          [ -f auditorias/Informe-WCAG-IAAP.xlsx ] && cp auditorias/Informe-WCAG-IAAP.xlsx public/auditorias/${FECHA}/ || echo "‚ö†Ô∏è Excel no encontrado."
          [ -f auditorias/Informe-WCAG-IAAP.zip ] && cp auditorias/Informe-WCAG-IAAP.zip public/auditorias/${FECHA}/ || echo "‚ö†Ô∏è ZIP no encontrado."
          [ -f auditorias/Resumen-WCAG.md ] && cp auditorias/Resumen-WCAG.md public/auditorias/${FECHA}/ || echo "‚ö†Ô∏è Resumen no encontrado."

          LAST_JSON=$(ls -t auditorias/results-merged-*.json 2>/dev/null | head -n1)
          if [ -n "$LAST_JSON" ]; then
            cp "$LAST_JSON" public/auditorias/${FECHA}/resultados.json
          else
            echo "‚ö†Ô∏è No se encontr√≥ results-merged.json."
            echo "[]" > public/auditorias/${FECHA}/resultados.json
          fi

          cp public/auditorias/${FECHA}/resultados.json public/auditorias/${FECHA}/data.json

          # P√°gina p√∫blica (dashboard IAAP PRO)
          cat > public/auditorias/${FECHA}/index.html <<'HTML'
          <!DOCTYPE html>
          <html lang="es">
          <head>
            <meta charset="utf-8" />
            <meta name="viewport" content="width=device-width, initial-scale=1" />
            <title>‚ôø Informe de Accesibilidad ‚Äì Il√∫mina Audit IAAP PRO</title>
            <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
            <style>
              body { font-family: system-ui, sans-serif; background: #f9fafc; color: #111; margin: 2em; }
              h1 { color: #003366; }
              section { background: white; border-radius: 12px; padding: 1.5em; margin-bottom: 2em; box-shadow: 0 2px 6px rgba(0,0,0,0.08); }
              canvas { max-width: 600px; margin: 1em auto; display: block; }
              iframe { width: 100%; height: 80vh; border-radius: 8px; border: 1px solid #ccc; }
              a.download {
                background: #004080; color: white; padding: .8em 1.5em; border-radius: 8px;
                text-decoration: none; display: inline-block; margin: 0.5em 0;
              }
              a.download:hover { background: #002b5e; }
              footer { text-align: center; font-size: .85em; color: #555; margin-top: 3em; }
              .downloads p { margin: .6em 0; }
            </style>
          </head>
          <body>
            <h1>‚ôø Informe de Accesibilidad Digital IAAP PRO</h1>
            <section>
              <h2>üìä Resumen general</h2>
              <p><strong>Sitio:</strong> <span id="site-url"></span></p>
              <p><strong>Fecha:</strong> <span id="fecha"></span></p>
              <p><strong>Conformidad estimada:</strong> <span id="conf"></span>%</p>
              <canvas id="chart"></canvas>
            </section>
            <section>
              <h2>üìÑ Informe PDF IAAP PRO</h2>
              <iframe src="Informe-WCAG-IAAP.pdf" title="Informe PDF IAAP"></iframe>
            </section>
            <section class="downloads">
              <h2>üíæ Archivos complementarios</h2>
              <p>üìò <a href="Informe-WCAG-IAAP.xlsx" class="download">Descargar Informe Excel IAAP</a></p>
              <p>üì¶ <a href="Informe-WCAG-IAAP.zip" class="download">Descargar ZIP Consolidado</a></p>
              <p>üßæ <a href="Resumen-WCAG.md" class="download">Ver Resumen en Markdown</a></p>
            </section>
            <footer>¬© Il√∫mina Audit IAAP ¬∑ 2025 ¬∑ Cumplimiento WCAG 2.1 / 2.2</footer>
            <script>
              fetch('data.json')
                .then(r => r.json())
                .then(d => {
                  const totalUrls = new Set(d.map(x => x.url)).size;
                  const impacts = d.flatMap(r => r.violations?.map(v => v.impact || 'unknown') || []);
                  const c = impacts.reduce((a, i) => { a[i] = (a[i] || 0) + 1; return a; }, {});
                  const p = (c.critical || 0)*2 + (c.serious || 0)*1.2 + (c.moderate || 0)*0.5 + (c.minor || 0)*0.2;
                  const conf = Math.max(0, 100 - p / Math.max(totalUrls, 1)).toFixed(1);
                  document.getElementById('site-url').textContent =
                    new URL(window.location).searchParams.get('site') || 'Desconocido';
                  document.getElementById('fecha').textContent = new Date().toLocaleString('es-ES');
                  document.getElementById('conf').textContent = conf;
                  new Chart(document.getElementById('chart'), {
                    type: 'doughnut',
                    data: {
                      labels: Object.keys(c),
                      datasets: [{
                        data: Object.values(c),
                        backgroundColor: ['#e53935','#fb8c00','#fdd835','#43a047']
                      }]
                    },
                    options: { plugins: { legend: { position: 'bottom' } } }
                  });
                });
            </script>
          </body>
          </html>
          HTML

      - name: üöÄ Publicar en GitHub Pages
        if: success() || always()
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./public
          publish_branch: gh-pages
          commit_message: "üöÄ Publicaci√≥n autom√°tica del Dashboard WCAG IAAP PRO con hist√≥rico"

      - name: üì§ Subir artefactos finales
        uses: actions/upload-artifact@v4
        with:
          name: "WCAG-Informe-${{ github.run_number }}"
          path: |
            auditorias/results-merged-*.json
            auditorias/Informe-WCAG-IAAP.xlsx
            auditorias/Informe-WCAG-IAAP.pdf
            auditorias/Resumen-WCAG.md
            auditorias/Informe-WCAG-IAAP.zip
            auditorias/capturas/**/*.png
          retention-days: 30

      - name: ‚úÖ Resumen final
        run: |
          FECHA=$(date +'%Y-%m-%d_%H-%M-%S')
          echo "==============================================="
          echo "‚ôø AUDITOR√çA COMPLETADA CORRECTAMENTE"
          echo "==============================================="
          echo "üåç Sitio auditado: $SITE_URL"
          echo "üìä Excel: auditorias/Informe-WCAG-IAAP.xlsx"
          echo "üìò Markdown: auditorias/Resumen-WCAG.md"
          echo "üñ®Ô∏è PDF: auditorias/Informe-WCAG-IAAP.pdf"
          echo "üíæ ZIP: auditorias/Informe-WCAG-IAAP.zip"
          echo "üåê Dashboard actual: https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/auditorias/${FECHA}/index.html"
          echo "üóÇ Hist√≥rico: https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/auditorias/"
          echo "‚úÖ Pipeline finalizado con √©xito."


