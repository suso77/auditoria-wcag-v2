name: â™¿ AuditorÃ­a de Accesibilidad â€“ IlÃºmina Audit IAAP PRO
run-name: "â™¿ AuditorÃ­a WCAG (${{ github.event.inputs.site_url || 'default' }})"

on:
  workflow_dispatch:
    inputs:
      site_url:
        description: "URL base del sitio a auditar"
        required: false
        default: "https://www.hiexperience.es"
  push:
    branches: [ main, master, principal ]
  pull_request:

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  a11y:
    runs-on: ubuntu-latest
    timeout-minutes: 90
    env:
      SITE_URL: ${{ github.event.inputs.site_url || vars.SITE_URL || 'https://www.hiexperience.es' }}
      BUILD_DATE: ${{ github.run_id }}-${{ github.run_number }}
      TZ: Europe/Madrid
      NODE_ENV: production
      NODE_OPTIONS: "--max-old-space-size=8192 --no-warnings"
      CYPRESS_screenshotsFolder: auditorias/capturas
      CYPRESS_video: false
      CYPRESS_screenshotOnRunFailure: true

    steps:
      - name: ðŸ§© Checkout del repositorio
        uses: actions/checkout@v4

      - name: âš™ï¸ Configurar Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "24"
          cache: "npm"

      - name: ðŸ§  Cachear dependencias pesadas
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/Cypress
            ~/.cache/puppeteer
          key: ${{ runner.os }}-a11y-v4.0-${{ hashFiles('package-lock.json') }}

      - name: ðŸ“¦ Instalar dependencias (modo estable)
        run: |
          echo "ðŸ“¦ Instalando dependencias..."
          set +e
          npm ci --include=dev || npm install --include=dev
          npm rebuild || true
          mkdir -p scripts auditorias/capturas auditorias/logs
          [ ! -f scripts/urls.json ] && echo "[]" > scripts/urls.json
          echo "âœ… Dependencias instaladas correctamente."

      - name: ðŸ§¹ Limpiar resultados anteriores
        run: |
          rm -rf auditorias/* || true
          mkdir -p auditorias/capturas auditorias/auditoria-sitemap auditorias/auditoria-interactiva
          [ ! -f scripts/urls.json ] && echo "[]" > scripts/urls.json
          echo "ðŸ§¹ Carpetas de auditorÃ­a listas."

      - name: ðŸ§ª Verificar instalaciÃ³n de Cypress
        run: |
          npx cypress verify || npx cypress install

      - name: ðŸŒ Rastreo del sitio
        timeout-minutes: 10
        run: |
          echo "::group::ðŸŒ Rastreo del sitio $SITE_URL"
          npm run crawl:js || echo "âš ï¸ Rastreo no disponible"
          node scripts/validate-urls.mjs || echo "âš ï¸ ValidaciÃ³n no crÃ­tica"
          echo "::endgroup::"

      # ==========================
      # â™¿ AuditorÃ­as principales
      # ==========================
      - name: â™¿ AuditorÃ­a de accesibilidad â€“ Sitemap (v4.0 IAAP PRO)
        uses: cypress-io/github-action@v6
        continue-on-error: true
        with:
          install-command: npm ci --include=dev || true
          command: >
            npx cypress run --browser chrome --headless --quiet --exit
            --config-file cypress.config.cjs
            --spec cypress/e2e/accesibilidad-sitemap.cy.js
        env:
          CYPRESS_baseUrl: ${{ env.SITE_URL }}

      - name: â±ï¸ Pausa breve antes de la siguiente auditorÃ­a
        run: sleep 10

      - name: â™¿ AuditorÃ­a de accesibilidad â€“ Componentes Interactivos (v4.0 IAAP PRO)
        uses: cypress-io/github-action@v6
        continue-on-error: true
        with:
          install-command: npm ci --include=dev || true
          command: >
            npx cypress run --browser chrome --headless --quiet --exit
            --config-file cypress.config.cjs
            --spec cypress/e2e/accesibilidad-interactiva.cy.js
        env:
          CYPRESS_baseUrl: ${{ env.SITE_URL }}

      # ==========================
      # ðŸ§© CombinaciÃ³n + resumen
      # ==========================
      - name: ðŸ§© Combinar resultados (v4.2 IAAP PRO)
        run: |
          echo "::group::â™¿ Combinando resultados IAAP..."
          node scripts/merge-results.mjs || echo "âš ï¸ Merge no crÃ­tico, se continÃºa."
          echo "::endgroup::"

      - name: ðŸ§¾ Generar resumen ejecutivo
        run: |
          LAST_JSON=$(ls -t auditorias/results-merged-*.json 2>/dev/null | head -n1)
          if [ -n "$LAST_JSON" ]; then
            node scripts/generate-summary.mjs "$LAST_JSON" > auditorias/Resumen-WCAG.md
          else
            echo "âš ï¸ No se generÃ³ resumen porque no hay resultados."
          fi

      - name: ðŸ“Š Exportar Excel IAAP
        run: node scripts/export-to-xlsx.mjs || echo "âš ï¸ Error exportando Excel IAAP."

      - name: ðŸ§© Instalar Puppeteer estable
        run: npm install puppeteer@22.7.1 --no-save

      - name: ðŸ–¨ï¸ Generar PDF IAAP profesional
        run: node scripts/generate-report.mjs || echo "âš ï¸ Error generando PDF IAAP."
        env:
          PUPPETEER_EXECUTABLE_PATH: /usr/bin/google-chrome-stable

      - name: ðŸ“¦ Generar ZIP consolidado
        run: |
          zip -r auditorias/Informe-WCAG-IAAP.zip auditorias/*.xlsx auditorias/*.pdf auditorias/*.md auditorias/results-merged-*.json || echo "âš ï¸ ZIP no generado"

      # ==========================
      # ðŸŒ Dashboard + artefactos
      # ==========================
      - name: ðŸŒ Generar Dashboard IAAP PRO (v4.0)
        run: |
          echo "::group::ðŸŒ Generando dashboard IAAP PRO..."
          mkdir -p public/auditorias/${BUILD_DATE}
          LAST_JSON=$(ls -t auditorias/results-merged-*.json 2>/dev/null | head -n1)
          if [ -z "$LAST_JSON" ]; then
            echo "[]" > public/auditorias/${BUILD_DATE}/resultados.json
          else
            cp "$LAST_JSON" public/auditorias/${BUILD_DATE}/resultados.json
          fi
          cp auditorias/*.pdf auditorias/*.xlsx auditorias/*.zip auditorias/*.md public/auditorias/${BUILD_DATE}/ 2>/dev/null || true
          echo "::endgroup::"
          echo "âœ… Dashboard IAAP generado correctamente."

      - name: ðŸ“¤ Subir artefactos IAAP
        uses: actions/upload-artifact@v4
        with:
          name: "WCAG-IAAP-${{ github.run_number }}"
          path: |
            auditorias/results-merged-*.json
            auditorias/*.pdf
            auditorias/*.xlsx
            auditorias/*.md
            auditorias/*.zip
            auditorias/capturas/**/*.png
          retention-days: 30

      - name: ðŸš€ Publicar en GitHub Pages
        if: success() && (hashFiles('auditorias/results-merged-*.json') != '')
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./public
          publish_branch: gh-pages
          commit_message: "ðŸš€ PublicaciÃ³n automÃ¡tica WCAG IAAP PRO v4.0 (${{ github.run_number }})"
