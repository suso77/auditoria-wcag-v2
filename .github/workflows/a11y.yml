name: ‚ôø Auditor√≠a de Accesibilidad ‚Äì Il√∫mina Audit IAAP PRO
run-name: "‚ôø Auditor√≠a WCAG (${{ github.event.inputs.site_url || 'default' }})"

on:
  workflow_dispatch:
    inputs:
      site_url:
        description: "URL base del sitio a auditar"
        required: false
        default: "https://www.hiexperience.es"
  push:
    branches: [ main, master, principal ]
  pull_request:

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  a11y:
    runs-on: ubuntu-latest
    timeout-minutes: 90
    env:
      SITE_URL: ${{ github.event.inputs.site_url || vars.SITE_URL || 'https://www.hiexperience.es' }}
      BUILD_DATE: ${{ github.run_id }}-${{ github.run_number }}
      TZ: Europe/Madrid
      NODE_ENV: production
      NODE_OPTIONS: "--max-old-space-size=4096 --experimental-specifier-resolution=node --no-warnings"
      PUPPETEER_EXECUTABLE_PATH: "/usr/bin/google-chrome-stable"
      CYPRESS_screenshotsFolder: auditorias/capturas
      CYPRESS_video: false
      CYPRESS_screenshotOnRunFailure: true

    steps:
      # =====================================================
      # üß© Setup base
      # =====================================================
      - name: üß© Checkout del repositorio
        uses: actions/checkout@v4

      - name: ‚öôÔ∏è Configurar Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: üß† Cachear dependencias pesadas
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/Cypress
            ~/.cache/puppeteer
          key: ${{ runner.os }}-a11y-${{ hashFiles('package-lock.json') }}

      - name: üì¶ Instalar dependencias
        run: |
          npm ci --include=dev
          npm rebuild
          mkdir -p scripts auditorias/capturas auditorias/logs
          [ ! -f scripts/urls.json ] && echo "[]" > scripts/urls.json

      - name: üßπ Limpiar resultados anteriores
        run: |
          rm -rf auditorias/* || true
          mkdir -p auditorias/capturas auditorias/auditoria-sitemap auditorias/auditoria-interactiva

      - name: üß™ Verificar instalaci√≥n de Cypress
        run: |
          npx cypress verify || npx cypress install

      # =====================================================
      # üåê Rastreo y validaciones previas
      # =====================================================
      - name: üåç Rastreo del sitio
        timeout-minutes: 10
        run: |
          echo "::group::üåç Rastreo del sitio $SITE_URL"
          npm run crawl:js || echo "‚ö†Ô∏è Rastreo no disponible"
          node scripts/validate-urls.mjs || echo "‚ö†Ô∏è Validaci√≥n no cr√≠tica"
          echo "::endgroup::"

      # =====================================================
      # ‚ôø Auditor√≠as principales
      # =====================================================
      - name: ‚ôø Auditor√≠a de accesibilidad ‚Äì Sitemap (v3.4.1)
        uses: cypress-io/github-action@v6
        continue-on-error: true
        with:
          install-command: npm ci --include=dev
          command: >
            npx cypress run --browser chrome --headless
            --config-file cypress.config.cjs
            --spec cypress/e2e/accesibilidad-sitemap.cy.js
        env:
          CYPRESS_baseUrl: ${{ env.SITE_URL }}

      - name: ‚ôø Auditor√≠a de accesibilidad ‚Äì Componentes Interactivos (v3.5.1)
        uses: cypress-io/github-action@v6
        continue-on-error: true
        with:
          install-command: npm ci --include=dev
          command: >
            npx cypress run --browser chrome --headless
            --config-file cypress.config.cjs
            --spec cypress/e2e/accesibilidad-interactiva.cy.js
        env:
          CYPRESS_baseUrl: ${{ env.SITE_URL }}

      # =====================================================
      # üß© Combinaci√≥n + resumen + exportaciones IAAP
      # =====================================================
      - name: üß© Combinar resultados
        run: |
          node scripts/merge-results.mjs || echo "‚ö†Ô∏è No hay resultados v√°lidos para combinar."
          if [ -z "$(ls auditorias/results-merged-*.json 2>/dev/null)" ]; then
            echo "[]" > auditorias/results-merged-placeholder.json
          fi

      - name: üßæ Generar resumen ejecutivo
        run: |
          if ls auditorias/results-merged-*.json >/dev/null 2>&1; then
            node scripts/generate-summary.mjs $(ls -t auditorias/results-merged-*.json | head -n1) > auditorias/Resumen-WCAG.md
          fi

      - name: üìä Exportar Excel IAAP
        run: node scripts/export-to-xlsx.mjs || echo "‚ö†Ô∏è Error exportando Excel."

      - name: üñ®Ô∏è Generar PDF IAAP profesional
        run: node scripts/generate-report.mjs || echo "‚ö†Ô∏è Error generando PDF."
        env:
          PUPPETEER_EXECUTABLE_PATH: /usr/bin/google-chrome-stable

      - name: üì¶ Generar ZIP consolidado
        run: |
          zip -r auditorias/Informe-WCAG-IAAP.zip auditorias/*.xlsx auditorias/*.pdf auditorias/*.md auditorias/results-merged-*.json || echo "‚ö†Ô∏è ZIP no generado"

      # =====================================================
      # üåê Dashboard p√∫blico y artefactos
      # =====================================================
      - name: üåê Publicar Dashboard
        run: |
          mkdir -p public/auditorias/${BUILD_DATE}
          cp auditorias/*.pdf auditorias/*.xlsx auditorias/*.zip auditorias/*.md public/auditorias/${BUILD_DATE}/ 2>/dev/null || true
          LAST_JSON=$(ls -t auditorias/results-merged-*.json 2>/dev/null | head -n1)
          if [ -n "$LAST_JSON" ]; then cp "$LAST_JSON" public/auditorias/${BUILD_DATE}/resultados.json; else echo "[]" > public/auditorias/${BUILD_DATE}/resultados.json; fi
          cp public/auditorias/${BUILD_DATE}/resultados.json public/auditorias/${BUILD_DATE}/data.json

          cat > public/auditorias/${BUILD_DATE}/index.html <<'HTML'
          <!DOCTYPE html>
          <html lang="es">
          <head>
            <meta charset="utf-8" />
            <title>‚ôø Informe de Accesibilidad IAAP PRO</title>
            <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
            <style>
              body { font-family: system-ui; background:#fafafa; color:#222; margin:2em; }
              h1 { color:#003366; }
              section { background:#fff; border-radius:12px; padding:1.5em; margin-bottom:2em; box-shadow:0 2px 6px rgba(0,0,0,0.08); }
              a.download { background:#004080; color:#fff; padding:0.8em 1.4em; border-radius:8px; text-decoration:none; }
              a.download:hover { background:#002b5e; }
              footer { text-align:center; font-size:0.85em; color:#555; margin-top:3em; }
            </style>
          </head>
          <body>
            <h1>‚ôø Informe de Accesibilidad Digital IAAP PRO</h1>
            <section>
              <h2>üìä Resumen</h2>
              <p><strong>Fecha:</strong> <span id="fecha"></span></p>
              <canvas id="chart"></canvas>
            </section>
            <section>
              <h2>üìÑ Informe PDF IAAP</h2>
              <iframe src="Informe-WCAG-IAAP.pdf" width="100%" height="600"></iframe>
            </section>
            <section>
              <h2>üíæ Descargas</h2>
              <p><a href="Informe-WCAG-IAAP.xlsx" class="download">Excel IAAP</a></p>
              <p><a href="Informe-WCAG-IAAP.zip" class="download">ZIP Consolidado</a></p>
              <p><a href="Resumen-WCAG.md" class="download">Resumen Markdown</a></p>
            </section>
            <footer>¬© Il√∫mina Audit IAAP ¬∑ 2025</footer>
            <script>
              fetch('data.json').then(r => r.json()).then(d => {
                const impacts = d.flatMap(r => r.violations?.map(v => v.impact) || []);
                const c = impacts.reduce((a,i)=>{a[i]=(a[i]||0)+1;return a;},{});
                new Chart(document.getElementById('chart'), {
                  type:'doughnut',
                  data:{labels:Object.keys(c),datasets:[{data:Object.values(c),backgroundColor:['#e53935','#fb8c00','#fdd835','#43a047']}]},
                  options:{plugins:{legend:{position:'bottom'}}}
                });
                document.getElementById('fecha').textContent = new Date().toLocaleString('es-ES');
              });
            </script>
          </body>
          </html>
          HTML

      - name: üì§ Subir artefactos
        uses: actions/upload-artifact@v4
        with:
          name: "WCAG-IAAP-${{ github.run_number }}"
          path: |
            auditorias/results-merged-*.json
            auditorias/*.pdf
            auditorias/*.xlsx
            auditorias/*.md
            auditorias/*.zip
            auditorias/capturas/**/*.png
          retention-days: 30

      - name: üöÄ Publicar en GitHub Pages
        if: success() || always()
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./public
          publish_branch: gh-pages
          commit_message: "üöÄ Publicaci√≥n autom√°tica WCAG IAAP PRO"

      - name: ‚úÖ Resumen final
        run: |
          echo "==============================================="
          echo "‚ôø AUDITOR√çA COMPLETADA CORRECTAMENTE"
          echo "==============================================="
          echo "üåç Sitio auditado: $SITE_URL"
          echo "üóÇ Dashboard: https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/auditorias/${BUILD_DATE}/index.html"
          echo "‚úÖ Pipeline finalizado con √©xito."

