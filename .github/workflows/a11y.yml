name: â™¿ AuditorÃ­a de Accesibilidad â€“ a11y CI
run-name: "â™¿ AuditorÃ­a WCAG (${{ github.event.inputs.site_url || 'default' }})"

on:
  workflow_dispatch:
    inputs:
      site_url:
        description: "URL base del sitio a auditar"
        required: false
        default: "https://www.hiexperience.es"
  push:
    branches: [ main, master, principal ]
  pull_request:
  # schedule:
  #   - cron: "0 3 * * 1"

jobs:
  a11y:
    runs-on: ubuntu-latest

    env:
      SITE_URL: ${{ github.event.inputs.site_url || vars.SITE_URL || 'https://www.hiexperience.es' }}
      LC_ALL: C.UTF-8
      LANG: C.UTF-8
      CRITICAL_MAX: 5
      SERIOUS_MAX: 20
      TZ: Europe/Madrid
      NODE_ENV: production
      NODE_OPTIONS: "--max-old-space-size=4096 --experimental-specifier-resolution=node"

    steps:
      # 1ï¸âƒ£ Clonar repositorio
      - name: ğŸ§© Checkout del repositorio
        uses: actions/checkout@v4

      # 2ï¸âƒ£ Configurar Node.js
      - name: âš™ï¸ Configurar Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: "**/package-lock.json"

      # âœ… 2.1 Cachear dependencias de Cypress y Puppeteer
      - name: ğŸ§  Cachear dependencias de Cypress y Puppeteer
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/Cypress
            ~/.cache/puppeteer
          key: ${{ runner.os }}-a11y-${{ hashFiles('package-lock.json', 'cypress.config.js') }}

      # ğŸ§¹ Limpieza previa
      - name: ğŸ§¹ Limpiar resultados antiguos
        run: |
          mkdir -p auditorias/capturas
          rm -rf auditorias/* || true

      # 3ï¸âƒ£ Instalar dependencias
      - name: ğŸ“¦ Instalar dependencias
        run: |
          echo "ğŸ“¦ Instalando dependencias..."
          npm ci || npm install
          echo "âœ… Dependencias instaladas correctamente."
          npm list --depth=0 || true

      # 4ï¸âƒ£ Verificar entorno de Cypress
      - name: ğŸ§© Verificar entorno de Cypress
        run: |
          echo "::group::ğŸ§© Verificando instalaciÃ³n de Cypress"
          npx cypress verify || (echo "âš ï¸ Cypress verification fallida, reinstalando..." && npx cypress install)
          echo "::endgroup::"

      # 4ï¸âƒ£.5 VerificaciÃ³n previa de entorno
      - name: ğŸ§¾ Validar entorno base
        run: node scripts/check-env.cjs

      # 5ï¸âƒ£ Rastreo de URLs con Puppeteer
      - name: ğŸŒ Rastreo de URLs
        run: |
          set -e
          echo "::group::ğŸŒ Rastreo de URLs en $SITE_URL"
          npm run crawl:js
          if [ ! -s scripts/urls.json ]; then
            echo "âŒ No se generÃ³ scripts/urls.json. Abortando auditorÃ­a."
            exit 1
          fi
          echo "âœ… Rastreo completado. Archivo: scripts/urls.json"
          echo "::endgroup::"

      # 6ï¸âƒ£ AuditorÃ­a general (Sitemap)
      - name: â™¿ AuditorÃ­a de accesibilidad â€“ Sitemap
        uses: cypress-io/github-action@v6
        continue-on-error: true
        with:
          install-command: npm ci
          command: npm run audit:sitemap
        env:
          SITE_URL: ${{ env.SITE_URL }}

      # 7ï¸âƒ£ AuditorÃ­a interactiva
      - name: ğŸ§  AuditorÃ­a de accesibilidad â€“ Componentes interactivos
        continue-on-error: true
        run: |
          echo "ğŸ§  Ejecutando auditorÃ­a de componentes interactivos..."
          npm run audit:interactiva || echo "âš ï¸ Script de auditorÃ­a interactiva no encontrado. Saltando..."
        env:
          SITE_URL: ${{ env.SITE_URL }}

      # ğŸ·ï¸ AÃ±adir campo "origen" a resultados
      - name: ğŸ·ï¸ AÃ±adir campo "origen" a los resultados
        run: |
          mkdir -p auditorias
          node scripts/tag-origen.cjs

      # 8ï¸âƒ£ Combinar resultados
      - name: ğŸ§© Combinar resultados
        run: |
          set -e
          mkdir -p auditorias
          echo "::group::ğŸ”„ Combinando resultados de auditorÃ­as"
          node scripts/merge-results.mjs
          echo "::endgroup::"
          echo "âœ… Archivo combinado generado correctamente."

      # 9ï¸âƒ£ Validar archivo combinado
      - name: ğŸ” Validar archivo combinado
        run: |
          set -e
          FILE=$(ls auditorias/results-merged-*.json 2>/dev/null | tail -n 1 || true)
          if [ -z "$FILE" ]; then
            echo "âŒ No se encontrÃ³ results-merged.json. Regenerando..."
            node scripts/merge-results.mjs
          elif [ ! -s "$FILE" ]; then
            echo "âš ï¸ Archivo vacÃ­o. Intentando reparar..."
            node scripts/merge-results.mjs || true
          else
            echo "âœ… Archivo vÃ¡lido detectado: $FILE"
          fi

      # ğŸ”Ÿ Resumen rÃ¡pido de severidades
      - name: ğŸ§® Resumen rÃ¡pido de severidades
        run: |
          echo "::group::ğŸ“Š Resumen de severidades detectadas"
          jq -r '[.[].violations[].impact] | group_by(.) | map({nivel: .[0], total: length})' auditorias/results-merged-*.json || echo "âš ï¸ jq no disponible o sin datos"
          echo "::endgroup::"

      # 11ï¸âƒ£ Quality Gate
      - name: ğŸš¦ Quality Gate â€“ WCAG
        continue-on-error: true
        run: |
          echo "==============================================="
          echo "ğŸš¦ INICIO DEL CONTROL DE CALIDAD"
          echo "==============================================="
          npm run quality || echo "âš ï¸ Control de calidad con advertencias"
          echo "==============================================="
          echo "âœ… FIN DEL CONTROL DE CALIDAD"
          echo "==============================================="

      # 12ï¸âƒ£ Exportar informe profesional
      - name: ğŸ“Š Exportar informe Excel + ZIP (IAAP / W3C)
        if: always()
        run: |
          set -e
          echo "::group::ğŸ“Š Generando informe profesional IAAP / W3C"
          FILE=$(ls auditorias/results-merged-*.json 2>/dev/null | tail -n 1 || true)
          if [ -z "$FILE" ]; then
            echo "âŒ No se encontrÃ³ archivo combinado. Abortando exportaciÃ³n."
            exit 1
          fi
          echo "ğŸ“„ Archivo combinado detectado: $FILE"
          node --max-old-space-size=4096 --experimental-specifier-resolution=node scripts/export-to-xlsx.mjs
          echo "::endgroup::"
          echo "âœ… Informe Excel y ZIP generados correctamente."
          echo "ğŸ“‚ Contenido de /auditorias:"
          ls -lh auditorias/ || echo "âš ï¸ Carpeta no encontrada."

      # 12.5ï¸âƒ£ Validar informe Excel antes de subir
      - name: ğŸ” Validar informe generado
        if: always()
        run: |
          if [ ! -f auditorias/Informe-WCAG-Profesional.xlsx ]; then
            echo "âŒ No se generÃ³ el informe Excel. Abortando subida."
            exit 1
          else
            echo "âœ… Informe Excel detectado correctamente."
          fi

      # 13ï¸âƒ£ Subir artefactos finales
      - name: ğŸ“¤ Subir artefactos finales
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: "WCAG-Informe-${{ github.run_number }}-${{ github.event.inputs.site_url || 'default' }}"
          path: |
            auditorias/results-merged-*.json
            auditorias/Informe-WCAG-Profesional.xlsx
            auditorias/Informe-WCAG.zip
            auditorias/capturas/**/*.png
          retention-days: 30

      # 14ï¸âƒ£ Resumen final
      - name: âœ… Resumen final de ejecuciÃ³n
        if: always()
        run: |
          echo "==============================================="
          echo "â™¿ RESUMEN FINAL DE LA AUDITORÃA"
          echo "==============================================="
          echo "ğŸŒ Sitio auditado: $SITE_URL"
          echo "ğŸ“Š Informe generado: auditorias/Informe-WCAG-Profesional.xlsx"
          echo "ğŸš¦ Quality Gate: Critical <= $CRITICAL_MAX, Serious <= $SERIOUS_MAX"
          echo "âœ… Pipeline completado correctamente."
