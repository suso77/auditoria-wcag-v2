name: â™¿ AuditorÃ­a de Accesibilidad â€“ a11y CI
run-name: "â™¿ AuditorÃ­a WCAG (${{ github.event.inputs.site_url || 'default' }})"

on:
  workflow_dispatch:
    inputs:
      site_url:
        description: "URL base del sitio a auditar"
        required: false
        default: "https://www.hiexperience.es"
  push:
    branches: [ main, master, principal ]
  pull_request:
  # schedule:
  #   - cron: "0 3 * * 1"  # (opcional) ejecuciÃ³n semanal automÃ¡tica

jobs:
  a11y:
    runs-on: ubuntu-latest

    env:
      SITE_URL: ${{ github.event.inputs.site_url || vars.SITE_URL || 'https://www.hiexperience.es' }}
      LC_ALL: C.UTF-8
      LANG: C.UTF-8
      CRITICAL_MAX: 5
      SERIOUS_MAX: 20
      TZ: Europe/Madrid
      NODE_ENV: production
      NODE_OPTIONS: "--max-old-space-size=4096 --experimental-specifier-resolution=node --no-warnings"

      TS_NODE_TRANSPILE_ONLY: true
      TS_NODE_PROJECT: tsconfig.json

      CYPRESS_screenshotsFolder: auditorias/capturas
      CYPRESS_video: false
      CYPRESS_screenshotOnRunFailure: true

    steps:
      # 1ï¸âƒ£ Checkout del repositorio
      - name: ğŸ§© Checkout del repositorio
        uses: actions/checkout@v4

      # 2ï¸âƒ£ Configurar Node.js
      - name: âš™ï¸ Configurar Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: "**/package-lock.json"

      # 3ï¸âƒ£ Cachear dependencias pesadas
      - name: ğŸ§  Cachear dependencias de Cypress y Puppeteer
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/Cypress
            ~/.cache/puppeteer
          key: ${{ runner.os }}-a11y-${{ hashFiles('package-lock.json', 'cypress.config.*') }}

      # 4ï¸âƒ£ Limpieza previa
      - name: ğŸ§¹ Limpiar resultados antiguos
        run: |
          rm -rf auditorias/* || true
          mkdir -p auditorias/capturas auditorias/logs

      # 5ï¸âƒ£ Instalar dependencias
      - name: ğŸ“¦ Instalar dependencias
        run: |
          echo "ğŸ“¦ Instalando dependencias..."
          npm ci || npm install
          mkdir -p scripts
          if [ ! -f scripts/urls.json ]; then echo "[]" > scripts/urls.json; fi
          echo "âœ… Dependencias instaladas correctamente."

      # 6ï¸âƒ£ Verificar ts-node
      - name: ğŸ§© Verificar ts-node
        run: npx ts-node --version || npm install ts-node typescript --no-save

      # 7ï¸âƒ£ Verificar entorno de Cypress
      - name: ğŸ§© Verificar entorno de Cypress
        run: |
          echo "::group::ğŸ§© Verificando instalaciÃ³n de Cypress"
          npx cypress verify || (echo "âš ï¸ Reinstalando Cypress..." && npx cypress install)
          echo "::endgroup::"

      # 8ï¸âƒ£ Validar entorno base
      - name: ğŸ§¾ Validar entorno base
        run: node scripts/check-env.cjs

      # 9ï¸âƒ£ Mostrar entorno detectado
      - name: ğŸ§  Mostrar entorno detectado
        run: |
          echo "::group::ğŸ§  Variables activas"
          node -p "({ SITE_URL: process.env.SITE_URL, NODE_ENV: process.env.NODE_ENV, TZ: process.env.TZ })"
          echo "::endgroup::"

      # ğŸ”Ÿ Validar URLs iniciales
      - name: ğŸ” Validar listado de URLs inicial
        run: |
          echo "::group::ğŸ” Validando scripts/urls.json"
          npx ts-node --transpile-only scripts/validate-urls.ts || echo "âš ï¸ Se generarÃ¡ en el siguiente paso"
          echo "::endgroup::"

      # 11ï¸âƒ£ Rastreo del sitio
      - name: ğŸŒ Rastreo de URLs
        timeout-minutes: 15
        run: |
          set -e
          echo "::group::ğŸŒ Rastreo en $SITE_URL"
          npm run crawl:js
          npx ts-node --transpile-only scripts/validate-urls.ts
          echo "::endgroup::"

      # 12ï¸âƒ£ AuditorÃ­a principal (Sitemap)
      - name: â™¿ AuditorÃ­a de accesibilidad â€“ Sitemap
        uses: cypress-io/github-action@v6
        continue-on-error: true
        with:
          install-command: npm ci
          command: |
            npx cypress run --browser chrome --headless --config-file cypress.config.cjs --spec "cypress/e2e/sitemap/**/*.cy.js" || npm run audit:sitemap
        env:
          SITE_URL: ${{ env.SITE_URL }}

      # 13ï¸âƒ£ AuditorÃ­a interactiva
      - name: ğŸ§  AuditorÃ­a de accesibilidad â€“ Componentes interactivos
        continue-on-error: true
        run: |
          npx cypress run --browser chrome --headless --config-file cypress.config.cjs --spec "cypress/e2e/interactiva/**/*.cy.js" || npm run audit:interactiva || echo "âš ï¸ No hay specs interactivas."

      # 14ï¸âƒ£ AÃ±adir campo origen
      - name: ğŸ·ï¸ AÃ±adir campo "origen" a los resultados
        run: node scripts/tag-origen.cjs

      # 15ï¸âƒ£ Combinar resultados
      - name: ğŸ§© Combinar resultados
        run: |
          set -e
          node scripts/merge-results.mjs
          echo "âœ… Archivo combinado generado correctamente."

      # 16ï¸âƒ£ Quality Gate
      - name: ğŸš¦ Quality Gate â€“ WCAG
        continue-on-error: true
        run: npm run quality || echo "âš ï¸ Quality Gate con advertencias"

      # 17ï¸âƒ£ Generar evidencias visuales
      - name: ğŸ“¸ Generar evidencias visuales (capturas WCAG)
        if: always()
        run: |
          echo "::group::ğŸ“¸ Generando evidencias visuales"
          if [ -f scripts/capture-evidence.mjs ]; then
            node --max-old-space-size=4096 --experimental-specifier-resolution=node scripts/capture-evidence.mjs
          else
            echo "âš ï¸ No se encontrÃ³ scripts/capture-evidence.mjs â€” se omite."
          fi
          echo "::endgroup::"
          echo "âœ… Capturas y metadatos generados en auditorias/capturas/"
        env:
          PUPPETEER_SKIP_DOWNLOAD: true

      # 18ï¸âƒ£ Exportar informe profesional
      - name: ğŸ“Š Exportar informe Excel + ZIP (IAAP / W3C)
        if: always()
        run: |
          set -e
          echo "::group::ğŸ“Š Generando informe profesional IAAP / W3C"
          node --max-old-space-size=4096 --experimental-specifier-resolution=node scripts/export-to-xlsx.mjs
          echo "::endgroup::"
          echo "âœ… Informe Excel y ZIP generados correctamente."
          ls -lh auditorias/

      # 19ï¸âƒ£ Generar resumen ejecutivo
      - name: ğŸ§¾ Generar resumen ejecutivo (Markdown)
        if: always()
        run: |
          node scripts/generate-summary.mjs auditorias/results-merged-*.json > auditorias/Resumen-WCAG.md || echo "âš ï¸ No se pudo generar resumen."

      # 20ï¸âƒ£ Validar informe final
      - name: ğŸ” Validar informe generado
        if: always()
        run: |
          if [ ! -f auditorias/Informe-WCAG-Profesional.xlsx ]; then
            echo "âŒ No se generÃ³ el informe Excel."
            exit 1
          fi
          echo "âœ… Informe Excel detectado correctamente."

      # 21ï¸âƒ£ Subir artefactos finales
      - name: ğŸ“¤ Subir artefactos finales
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: "WCAG-Informe-${{ github.run_number }}-${{ github.event.inputs.site_url || 'default' }}"
          path: |
            auditorias/results-merged-*.json
            auditorias/Informe-WCAG-Profesional.xlsx
            auditorias/Informe-WCAG.zip
            auditorias/Resumen-WCAG.md
            auditorias/capturas/**/*.png
          retention-days: 30

      # 22ï¸âƒ£ Resumen final
      - name: âœ… Resumen final de ejecuciÃ³n
        if: always()
        run: |
          echo "==============================================="
          echo "â™¿ RESUMEN FINAL DE LA AUDITORÃA"
          echo "==============================================="
          echo "ğŸŒ Sitio auditado: $SITE_URL"
          echo "ğŸ“Š Informe generado: auditorias/Informe-WCAG-Profesional.xlsx"
          echo "ğŸ“¸ Capturas incluidas en ZIP"
          echo "ğŸš¦ Quality Gate: Critical <= $CRITICAL_MAX, Serious <= $SERIOUS_MAX"
          echo "âœ… Pipeline completado correctamente."
