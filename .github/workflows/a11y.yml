name: ‚ôø Auditor√≠a de Accesibilidad ‚Äì a11y CI
run-name: "‚ôø Auditor√≠a WCAG (${{ github.event.inputs.site_url || 'default' }})"

on:
  workflow_dispatch:
    inputs:
      site_url:
        description: "URL base del sitio a auditar"
        required: false
        default: "https://www.hiexperience.es"
  push:
    branches: [ main, master, principal ]
  pull_request:
  # schedule:
  #   - cron: "0 3 * * 1"  # (opcional) ejecuci√≥n semanal autom√°tica

jobs:
  a11y:
    runs-on: ubuntu-latest

    env:
      SITE_URL: ${{ github.event.inputs.site_url || vars.SITE_URL || 'https://www.hiexperience.es' }}
      LC_ALL: C.UTF-8
      LANG: C.UTF-8
      CRITICAL_MAX: 5
      SERIOUS_MAX: 20
      TZ: Europe/Madrid
      NODE_ENV: production
      NODE_OPTIONS: "--max-old-space-size=4096 --experimental-specifier-resolution=node"

      # üß© Compatibilidad con ts-node / TypeScript
      TS_NODE_TRANSPILE_ONLY: true
      TS_NODE_PROJECT: tsconfig.json

      # üì∏ Configuraci√≥n de Cypress para evidencias autom√°ticas
      CYPRESS_screenshotsFolder: auditorias/capturas
      CYPRESS_video: false
      CYPRESS_screenshotOnRunFailure: true

    steps:
      # 1Ô∏è‚É£ Clonar repositorio
      - name: üß© Checkout del repositorio
        uses: actions/checkout@v4

      # 2Ô∏è‚É£ Configurar Node.js
      - name: ‚öôÔ∏è Configurar Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: "**/package-lock.json"

      # ‚úÖ 2.1 Cachear dependencias de Cypress y Puppeteer
      - name: üß† Cachear dependencias de Cypress y Puppeteer
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/Cypress
            ~/.cache/puppeteer
          key: ${{ runner.os }}-a11y-${{ hashFiles('package-lock.json', 'cypress.config.*') }}

      # üßπ Limpieza previa
      - name: üßπ Limpiar resultados antiguos
        run: |
          mkdir -p auditorias/capturas
          rm -rf auditorias/* || true

      # 3Ô∏è‚É£ Instalar dependencias
      - name: üì¶ Instalar dependencias
        run: |
          echo "üì¶ Instalando dependencias..."
          npm ci || npm install
          mkdir -p scripts
          if [ ! -f scripts/urls.json ]; then echo "[]" > scripts/urls.json; fi
          echo "‚úÖ Dependencias instaladas correctamente."
          npm list --depth=0 || true

      # 3Ô∏è‚É£.1 Verificar instalaci√≥n de ts-node (para TypeScript)
      - name: üß© Verificar ts-node
        run: |
          npx ts-node --version || npm install ts-node typescript --no-save

      # 4Ô∏è‚É£ Verificar entorno de Cypress
      - name: üß© Verificar entorno de Cypress
        run: |
          echo "::group::üß© Verificando instalaci√≥n de Cypress"
          npx cypress verify || (echo "‚ö†Ô∏è Cypress verification fallida, reinstalando..." && npx cypress install)
          echo "::endgroup::"

      # 4Ô∏è‚É£.5 Verificaci√≥n previa de entorno
      - name: üßæ Validar entorno base
        run: node scripts/check-env.cjs

      # üß† Mostrar entorno detectado
      - name: üß† Mostrar entorno detectado
        run: |
          echo "::group::üß† Variables de entorno activas"
          node -p "({ SITE_URL: process.env.SITE_URL, NODE_ENV: process.env.NODE_ENV, CRITICAL_MAX: process.env.CRITICAL_MAX, SERIOUS_MAX: process.env.SERIOUS_MAX, TZ: process.env.TZ })"
          echo "::endgroup::"

      # 5Ô∏è‚É£ Validar URLs antes del rastreo
      - name: üîç Validar listado de URLs inicial
        run: |
          echo "::group::üîç Validando scripts/urls.json"
          npx ts-node scripts/validate-urls.ts || echo "‚ö†Ô∏è No existe a√∫n scripts/urls.json (se generar√° en el siguiente paso)"
          echo "::endgroup::"

      # 6Ô∏è‚É£ Rastreo de URLs con Puppeteer
      - name: üåê Rastreo de URLs
        run: |
          set -e
          echo "::group::üåç Rastreo de URLs en $SITE_URL"
          npm run crawl:js
          if [ ! -s scripts/urls.json ]; then
            echo "‚ùå No se gener√≥ scripts/urls.json. Abortando auditor√≠a."
            exit 1
          fi
          npx ts-node scripts/validate-urls.ts
          echo "‚úÖ Rastreo completado y URLs validadas."
          echo "::endgroup::"

      # üß© Validaci√≥n final antes de auditor√≠as
      - name: üîÅ Validar URLs antes de auditor√≠as
        run: npx ts-node scripts/validate-urls.ts

      # 7Ô∏è‚É£ Auditor√≠a general (Sitemap)
      - name: ‚ôø Auditor√≠a de accesibilidad ‚Äì Sitemap
        uses: cypress-io/github-action@v6
        continue-on-error: true
        with:
          install-command: npm ci
          command: |
            npx ts-node scripts/validate-urls.ts
            npm run audit:sitemap
        env:
          SITE_URL: ${{ env.SITE_URL }}

      # 8Ô∏è‚É£ Auditor√≠a interactiva
      - name: üß† Auditor√≠a de accesibilidad ‚Äì Componentes interactivos
        continue-on-error: true
        run: |
          npx ts-node scripts/validate-urls.ts
          npm run audit:interactiva || echo "‚ö†Ô∏è Script de auditor√≠a interactiva no encontrado. Saltando..."
        env:
          SITE_URL: ${{ env.SITE_URL }}

      # üè∑Ô∏è A√±adir campo "origen" a resultados
      - name: üè∑Ô∏è A√±adir campo "origen" a los resultados
        run: |
          mkdir -p auditorias
          node scripts/tag-origen.cjs

      # 9Ô∏è‚É£ Combinar resultados
      - name: üß© Combinar resultados
        run: |
          set -e
          mkdir -p auditorias
          echo "::group::üîÑ Combinando resultados de auditor√≠as"
          node scripts/merge-results.mjs
          echo "::endgroup::"
          echo "‚úÖ Archivo combinado generado correctamente."

      # üîü Validar archivo combinado
      - name: üîç Validar archivo combinado
        run: |
          set -e
          FILE=$(ls auditorias/results-merged-*.json 2>/dev/null | tail -n 1 || true)
          if [ -z "$FILE" ]; then
            echo "‚ùå No se encontr√≥ results-merged.json. Regenerando..."
            node scripts/merge-results.mjs
          elif [ ! -s "$FILE" ]; then
            echo "‚ö†Ô∏è Archivo vac√≠o. Intentando reparar..."
            node scripts/merge-results.mjs || true
          else
            echo "‚úÖ Archivo v√°lido detectado: $FILE"
          fi

      # 11Ô∏è‚É£ Resumen r√°pido de severidades
      - name: üßÆ Resumen r√°pido de severidades
        run: |
          echo "::group::üìä Resumen de severidades detectadas"
          if command -v jq >/dev/null 2>&1; then
            jq -r '[.[].violations[].impact] | group_by(.) | map({nivel: .[0], total: length})' auditorias/results-merged-*.json || echo "‚ö†Ô∏è jq no disponible o sin datos"
          else
            echo "‚ö†Ô∏è jq no instalado, omitiendo resumen r√°pido"
          fi
          echo "::endgroup::"

      # 12Ô∏è‚É£ Quality Gate
      - name: üö¶ Quality Gate ‚Äì WCAG
        continue-on-error: true
        run: |
          echo "==============================================="
          echo "üö¶ INICIO DEL CONTROL DE CALIDAD"
          echo "==============================================="
          npm run quality || echo "‚ö†Ô∏è Control de calidad con advertencias"
          echo "==============================================="
          echo "‚úÖ FIN DEL CONTROL DE CALIDAD"
          echo "==============================================="

      # 13Ô∏è‚É£ Exportar informe profesional
      - name: üìä Exportar informe Excel + ZIP (IAAP / W3C)
        if: always()
        run: |
          set -e
          mkdir -p auditorias
          echo "::group::üìä Generando informe profesional IAAP / W3C"
          FILE=$(ls auditorias/results-merged-*.json 2>/dev/null | tail -n 1 || true)
          if [ -z "$FILE" ]; then
            echo "‚ùå No se encontr√≥ archivo combinado. Abortando exportaci√≥n."
            exit 1
          fi
          echo "üìÑ Archivo combinado detectado: $FILE"
          node --max-old-space-size=4096 --experimental-specifier-resolution=node scripts/export-to-xlsx.mjs
          echo "::endgroup::"
          echo "‚úÖ Informe Excel y ZIP generados correctamente."
          echo "üìÇ Contenido de /auditorias:"
          ls -lh auditorias/ || echo "‚ö†Ô∏è Carpeta no encontrada."

      # 14Ô∏è‚É£ Generar resumen ejecutivo (Markdown)
      - name: üßæ Generar resumen ejecutivo (Markdown)
        if: always()
        run: |
          echo "üßæ Generando resumen ejecutivo WCAG..."
          node scripts/generate-summary.mjs auditorias/results-merged-*.json > auditorias/Resumen-WCAG.md || echo "‚ö†Ô∏è No se pudo generar resumen (script opcional)."

      # 15Ô∏è‚É£ Validar informe Excel antes de subir
      - name: üîç Validar informe generado
        if: always()
        run: |
          if [ ! -f auditorias/Informe-WCAG-Profesional.xlsx ]; then
            echo "‚ùå No se gener√≥ el informe Excel. Abortando subida."
            exit 1
          else
            echo "‚úÖ Informe Excel detectado correctamente."
          fi

      # 16Ô∏è‚É£ Subir artefactos finales
      - name: üì§ Subir artefactos finales
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: "WCAG-Informe-${{ github.run_number }}-${{ github.event.inputs.site_url || 'default' }}"
          path: |
            auditorias/results-merged-*.json
            auditorias/Informe-WCAG-Profesional.xlsx
            auditorias/Informe-WCAG.zip
            auditorias/Resumen-WCAG.md
            auditorias/capturas/**/*.png
          retention-days: 30

      # 17Ô∏è‚É£ Resumen final
      - name: ‚úÖ Resumen final de ejecuci√≥n
        if: always()
        run: |
          echo "==============================================="
          echo "‚ôø RESUMEN FINAL DE LA AUDITOR√çA"
          echo "==============================================="
          echo "üåç Sitio auditado: $SITE_URL"
          echo "üìä Informe generado: auditorias/Informe-WCAG-Profesional.xlsx"
          echo "üö¶ Quality Gate: Critical <= $CRITICAL_MAX, Serious <= $SERIOUS_MAX"
          echo "‚úÖ Pipeline completado correctamente."
