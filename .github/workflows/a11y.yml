name: â™¿ AuditorÃ­a de Accesibilidad â€“ IlÃºmina Audit IAAP PRO
run-name: "â™¿ AuditorÃ­a WCAG (${{ github.event.inputs.site_url || 'default' }})"

on:
  workflow_dispatch:
    inputs:
      site_url:
        description: "URL base del sitio a auditar"
        required: false
        default: "https://www.hiexperience.es"
  push:
    branches: [ main, master, principal ]
  pull_request:

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  a11y:
    runs-on: ubuntu-latest
    timeout-minutes: 90
    defaults:
      run:
        working-directory: ${{ github.workspace }}

    env:
      SITE_URL: ${{ github.event.inputs.site_url || vars.SITE_URL || 'https://www.hiexperience.es' }}
      LC_ALL: C.UTF-8
      LANG: C.UTF-8
      TZ: Europe/Madrid
      NODE_ENV: production
      NODE_OPTIONS: "--max-old-space-size=4096 --experimental-specifier-resolution=node --no-warnings"
      TS_NODE_TRANSPILE_ONLY: true
      TS_NODE_PROJECT: tsconfig.json
      TS_NODE_COMPILER_OPTIONS: '{"module":"esnext"}'
      CRITICAL_MAX: 5
      SERIOUS_MAX: 20
      PUPPETEER_EXECUTABLE_PATH: "/usr/bin/google-chrome-stable"
      CYPRESS_screenshotsFolder: auditorias/capturas
      CYPRESS_video: false
      CYPRESS_screenshotOnRunFailure: true

    steps:
      # =====================================================
      # ğŸ§© Setup base
      # =====================================================
      - name: ğŸ§© Checkout del repositorio
        uses: actions/checkout@v4

      - name: âš™ï¸ Configurar Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          check-latest: true
          cache: "npm"
          cache-dependency-path: "**/package-lock.json"

      - name: ğŸ§  Cachear dependencias pesadas
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/Cypress
            ~/.cache/puppeteer
          key: ${{ runner.os }}-a11y-${{ hashFiles('package-lock.json', 'cypress.config.*') }}

      - name: ğŸ§¹ Limpiar resultados anteriores
        run: |
          rm -rf auditorias/* || true
          mkdir -p auditorias/capturas auditorias/logs

      - name: ğŸ“¦ Instalar dependencias
        run: |
          npm ci --include=dev
          npm rebuild
          mkdir -p scripts
          if [ ! -f scripts/urls.json ]; then echo "[]" > scripts/urls.json; fi

      - name: ğŸ§© Instalar ts-node y TypeScript (fallback)
        run: |
          if ! npx ts-node --version >/dev/null 2>&1; then
            npm install --no-save ts-node typescript @types/node
          fi

      - name: ğŸ§ª Verificar instalaciÃ³n de Cypress
        run: |
          if ! npx cypress --version >/dev/null 2>&1; then
            npm install cypress --no-save
          fi
          npx cypress verify || npx cypress install

      # =====================================================
      # ğŸ§¾ Validaciones previas
      # =====================================================
      - name: ğŸ§¾ Validar entorno base
        run: node scripts/check-env.cjs

      - name: ğŸ” Validar listado de URLs inicial
        run: node scripts/validate-urls.mjs || echo "âš ï¸ Se generarÃ¡ mÃ¡s adelante"

      - name: ğŸŒ Rastreo del sitio
        timeout-minutes: 15
        run: |
          echo "::group::ğŸŒ Rastreo en $SITE_URL"
          npm run crawl:js || echo "âš ï¸ Rastreo no disponible"
          node scripts/validate-urls.mjs || echo "âš ï¸ ValidaciÃ³n no crÃ­tica"
          echo "::endgroup::"

      # =====================================================
      # â™¿ AuditorÃ­as principales
      # =====================================================
      - name: â™¿ AuditorÃ­a de accesibilidad â€“ Sitemap
        uses: cypress-io/github-action@v6
        continue-on-error: true
        with:
          install-command: npm ci --include=dev
          command: > 
            # âœ… FIX: eliminado NODE_OPTIONS="" (causaba error en GitHub Actions)
            npx cypress run --browser chrome --headless
            --config-file cypress.config.cjs
            --spec "cypress/e2e/accesibilidad-sitemap.cy.js"

      - name: ğŸ§  AuditorÃ­a de accesibilidad â€“ Componentes interactivos
        continue-on-error: true
        run: |
          # âœ… FIX: eliminado NODE_OPTIONS="" (causaba error en GitHub Actions)
          npx cypress run --browser chrome --headless --config-file cypress.config.cjs \
            --spec "cypress/e2e/accesibilidad-interactiva.cy.js" \
            || echo "âš ï¸ No hay specs interactivas o se omitieron."

      - name: ğŸ·ï¸ AÃ±adir campo "origen"
        run: node scripts/tag-origen.cjs || echo "â„¹ï¸ Campo origen no necesario"

      # =====================================================
      # ğŸ§© CombinaciÃ³n + resumen + quality
      # =====================================================
      - name: ğŸ§© Combinar resultados (merge-results.mjs)
        run: |
          # âœ… FIX: no romper flujo si archivo estÃ¡ vacÃ­o o no existe
          node scripts/merge-results.mjs || echo "âš ï¸ No hay resultados vÃ¡lidos para combinar."

      - name: ğŸ§¾ Generar resumen ejecutivo (Markdown)
        run: |
          if ls auditorias/results-merged-*.json >/dev/null 2>&1; then
            node scripts/generate-summary.mjs $(ls -t auditorias/results-merged-*.json | head -n1) \
              > auditorias/Resumen-WCAG.md
          else
            echo "âš ï¸ No se generÃ³ resumen: no hay resultados combinados."
          fi

      - name: ğŸš¦ Quality Gate â€“ WCAG
        continue-on-error: true
        run: |
          npm run quality || echo "âš ï¸ Quality Gate con advertencias."

      # =====================================================
      # ğŸ“Š Exportaciones IAAP
      # =====================================================
      - name: ğŸ“Š Exportar informe Excel IAAP
        run: node scripts/export-to-xlsx.mjs || echo "âš ï¸ Error no crÃ­tico exportando Excel." # âœ… FIX tolerancia

      - name: ğŸ–¨ï¸ Generar PDF IAAP profesional
        run: node scripts/generate-report.mjs || echo "âš ï¸ Error no crÃ­tico generando PDF." # âœ… FIX tolerancia
        env:
          PUPPETEER_EXECUTABLE_PATH: /usr/bin/google-chrome-stable

      - name: ğŸ“¸ Generar evidencias visuales
        if: always()
        run: |
          if [ -f scripts/capture-evidence.mjs ]; then
            node scripts/capture-evidence.mjs || echo "âš ï¸ Capturas no generadas."
          else
            echo "â„¹ï¸ No hay script de capturas."
          fi

      - name: ğŸ“¦ Generar ZIP consolidado
        run: |
          zip -r auditorias/Informe-WCAG-Completo.zip auditorias/*.xlsx auditorias/*.pdf auditorias/*.md auditorias/results-merged-*.json || echo "âš ï¸ ZIP no generado"

      # =====================================================
      # ğŸŒ PublicaciÃ³n Dashboard + HistÃ³rico
      # =====================================================
      - name: ğŸ§± Preparar carpeta pÃºblica
        run: |
          FECHA=$(date +'%Y-%m-%d_%H-%M-%S')
          mkdir -p public/auditorias/${FECHA}
          cp auditorias/Informe-WCAG-Profesional.pdf public/auditorias/${FECHA}/
          cp auditorias/Resumen-WCAG.md public/auditorias/${FECHA}/
          cp auditorias/Informe-WCAG-Completo.zip public/auditorias/${FECHA}/
          cp $(ls -t auditorias/results-merged-*.json | head -n1) public/auditorias/${FECHA}/resultados.json

          # Generar dashboard individual
          cp public/auditorias/${FECHA}/resultados.json public/auditorias/${FECHA}/data.json
          cat > public/auditorias/${FECHA}/index.html <<'HTML'
          <!DOCTYPE html>
          <html lang="es">
          <head>
            <meta charset="utf-8">
            <meta name="viewport" content="width=device-width, initial-scale=1">
            <title>â™¿ Informe WCAG â€“ IlÃºmina Audit IAAP</title>
            <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
            <style>
              body { font-family: system-ui, sans-serif; background: #f9fafc; color: #111; margin: 2em; }
              h1 { color: #003366; }
              section { background: white; border-radius: 12px; padding: 1.5em; margin-bottom: 2em; box-shadow: 0 2px 6px rgba(0,0,0,0.08); }
              canvas { max-width: 600px; margin: 1em auto; display: block; }
              iframe { width: 100%; height: 80vh; border-radius: 8px; border: 1px solid #ccc; }
              button { background: #004080; color: white; border: none; padding: .8em 1.5em; border-radius: 8px; cursor: pointer; }
              footer { text-align: center; font-size: .85em; color: #555; margin-top: 3em; }
            </style>
          </head>
          <body>
            <h1>â™¿ Informe de Accesibilidad WCAG</h1>
            <section>
              <h2>ğŸ“Š Resumen</h2>
              <p><strong>Sitio:</strong> <span id="site-url"></span></p>
              <p><strong>Fecha:</strong> <span id="fecha"></span></p>
              <p><strong>Conformidad:</strong> <span id="conf"></span>%</p>
              <canvas id="chart"></canvas>
            </section>

            <section>
              <h2>ğŸ“„ Informe PDF IAAP</h2>
              <iframe src="Informe-WCAG-Profesional.pdf" title="Informe PDF"></iframe>
            </section>

            <section>
              <h2>ğŸ’¾ Descargas</h2>
              <button onclick="window.open('Informe-WCAG-Completo.zip')">â¬‡ï¸ Descargar Informe Completo (ZIP)</button>
              <p><a href="Resumen-WCAG.md">ğŸ“˜ Ver resumen Markdown</a></p>
            </section>

            <footer>Â© IlÃºmina Audit IAAP Â· 2025</footer>

            <script>
              fetch('data.json')
                .then(r=>r.json())
                .then(d=>{
                  const totalUrls=new Set(d.map(x=>x.url)).size;
                  const impacts=d.flatMap(r=>r.violations?.map(v=>v.impact||'unknown')||[]);
                  const c=impacts.reduce((a,i)=>{a[i]=(a[i]||0)+1;return a;}, {});
                  const p=(c.critical||0)*2+(c.serious||0)*1.2+(c.moderate||0)*0.5+(c.minor||0)*0.2;
                  const conf=Math.max(0,100-p/Math.max(totalUrls,1)).toFixed(1);
                  document.getElementById('site-url').textContent=new URL(window.location).searchParams.get('site')||'Desconocido';
                  document.getElementById('fecha').textContent=new Date().toLocaleString('es-ES');
                  document.getElementById('conf').textContent=conf;
                  new Chart(document.getElementById('chart'),{type:'doughnut',data:{labels:Object.keys(c),datasets:[{data:Object.values(c),backgroundColor:['#e53935','#fb8c00','#fdd835','#43a047']}]},options:{plugins:{legend:{position:'bottom'}}}});
                });
            </script>
          </body>
          </html>
          HTML

          # Actualizar histÃ³rico
          mkdir -p public/auditorias
          echo "<!DOCTYPE html><html lang='es'><head><meta charset='utf-8'><title>HistÃ³rico de auditorÃ­as WCAG</title><style>body{font-family:sans-serif;margin:2em;background:#f9fafc;}table{border-collapse:collapse;width:100%;}th,td{border:1px solid #ccc;padding:.5em;text-align:left;}th{background:#004080;color:white;}</style></head><body><h1>ğŸ“œ HistÃ³rico de AuditorÃ­as WCAG</h1><table><tr><th>Fecha</th><th>Conformidad</th><th>Informe</th></tr>" > public/auditorias/index.html
          for dir in $(ls -dt public/auditorias/*/ | head -n 20); do
            if [ -f "${dir}data.json" ]; then
              CONF=$(node -e "const d=require('${dir}data.json');const t=new Set(d.map(x=>x.url)).size;const i=d.flatMap(r=>r.violations?.map(v=>v.impact||'unknown')||[]);const c=i.reduce((a,x)=>{a[x]=(a[x]||0)+1;return a;},{});const p=(c.critical||0)*2+(c.serious||0)*1.2+(c.moderate||0)*0.5+(c.minor||0)*0.2;console.log((100-p/Math.max(t,1)).toFixed(1));")
              echo "<tr><td>${dir#public/auditorias/}</td><td>${CONF}%</td><td><a href='${dir#public/}'>Ver informe</a></td></tr>" >> public/auditorias/index.html
            fi
          done
          echo "</table><p>ğŸ§© IlÃºmina Audit IAAP â€“ generado automÃ¡ticamente</p></body></html>" >> public/auditorias/index.html

      - name: ğŸš€ Publicar en GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./public
          publish_branch: gh-pages
          commit_message: "ğŸš€ PublicaciÃ³n automÃ¡tica del Dashboard WCAG IAAP PRO con histÃ³rico"

      # =====================================================
      # ğŸ“¤ Artefactos + resumen final
      # =====================================================
      - name: ğŸ“¤ Subir artefactos finales
        uses: actions/upload-artifact@v4
        with:
          name: "WCAG-Informe-${{ github.run_number }}"
          path: |
            auditorias/results-merged-*.json
            auditorias/Informe-WCAG-Profesional.xlsx
            auditorias/Informe-WCAG-Profesional.pdf
            auditorias/Resumen-WCAG.md
            auditorias/Informe-WCAG-Completo.zip
            auditorias/capturas/**/*.png
          retention-days: 30

      - name: âœ… Resumen final
        run: |
          echo "==============================================="
          echo "â™¿ AUDITORÃA COMPLETADA CORRECTAMENTE"
          echo "==============================================="
          echo "ğŸŒ Sitio auditado: $SITE_URL"
          echo "ğŸ“Š Excel: auditorias/Informe-WCAG-Profesional.xlsx"
          echo "ğŸ“˜ Markdown: auditorias/Resumen-WCAG.md"
          echo "ğŸ–¨ï¸ PDF: auditorias/Informe-WCAG-Profesional.pdf"
          echo "ğŸ’¾ ZIP: auditorias/Informe-WCAG-Completo.zip"
          echo "ğŸŒ Dashboard actual: https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/auditorias/${FECHA}/index.html"
          echo "ğŸ—‚ HistÃ³rico: https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/auditorias/"
          echo "âœ… Pipeline finalizado con Ã©xito."
