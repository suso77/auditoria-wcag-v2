name: â™¿ AuditorÃ­a de Accesibilidad â€“ a11y CI

on:
  workflow_dispatch:
    inputs:
      site_url:
        description: "URL base del sitio a auditar"
        required: false
        default: "https://www.hiexperience.es"
  push:
    branches: [ main, master, principal ]
  pull_request:

jobs:
  a11y:
    runs-on: ubuntu-latest

    env:
      SITE_URL: ${{ github.event.inputs.site_url || 'https://www.hiexperience.es' }}
      LC_ALL: C.UTF-8
      LANG: C.UTF-8
      CRITICAL_MAX: 0
      SERIOUS_MAX: 5

    steps:
      # 1ï¸âƒ£ Clonar el repositorio
      - name: ğŸ§© Checkout del repositorio
        uses: actions/checkout@v4

      # 2ï¸âƒ£ Configurar Node.js (forzar recacheo del package.json actualizado)
      - name: âš™ï¸ Configurar Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: '**/package-lock.json'

      # 3ï¸âƒ£ Instalar dependencias
      - name: ğŸ“¦ Instalar dependencias
        run: npm ci

      # 4ï¸âƒ£ Rastreo automÃ¡tico de URLs (crawler con Puppeteer)
      - name: ğŸŒ Rastreo de URLs (crawler con JS)
        run: |
          echo "==============================================="
          echo "ğŸŒ INICIO DEL RASTREO DE URLs"
          echo "==============================================="
          echo "ğŸ”— Rastreando sitio: $SITE_URL"
          echo ""
          
          # Ejecutar el crawler en formato .mjs
          if [ -f "crawler/crawl-puppeteer.mjs" ]; then
            node crawler/crawl-puppeteer.mjs
          else
            echo "âŒ ERROR: No se encontrÃ³ crawler/crawl-puppeteer.mjs"
            exit 1
          fi
          
          echo ""
          echo "âœ… Rastreo completado correctamente"
          echo "ğŸ“ Archivo generado: scripts/urls.json"
          echo "==============================================="
        env:
          SITE_URL: ${{ env.SITE_URL }}

      # 5ï¸âƒ£ AuditorÃ­a con Cypress + axe-core
      - name: â™¿ Ejecutar auditorÃ­a de accesibilidad
        uses: cypress-io/github-action@v6
        with:
          install-command: npm ci
          command: npm run auditoria || echo "âš ï¸ Violaciones detectadas, continuamos..."
        env:
          SITE_URL: ${{ env.SITE_URL }}

      # 6ï¸âƒ£ Fusionar todos los resultados (results.json)
      - name: ğŸ§© Combinar resultados de auditorÃ­a
        run: |
          echo "ğŸ”„ Combinando results.json en un solo archivo..."
          node scripts/merge-results.cjs
          echo "âœ… Archivo combinado creado correctamente."

      # 7ï¸âƒ£ Generar informe Excel profesional + ZIP con evidencias
      - name: ğŸ“Š Generar informe Excel y ZIP
        run: |
          echo "ğŸ“„ Generando informe WCAG + evidencias..."
          node scripts/export-to-xlsx.cjs
          echo "âœ… Informe Excel y ZIP generados correctamente."

      # 8ï¸âƒ£ Control de calidad (Quality Gate - modo auditorÃ­a)
      - name: ğŸš¦ Control de calidad (Quality Gate - modo auditorÃ­a)
        run: |
          echo "==============================================="
          echo "ğŸš¦ INICIO DEL CONTROL DE CALIDAD (QUALITY GATE)"
          echo "==============================================="
          echo "ğŸ§© Ejecutando Quality Gate en modo CommonJS..."
          echo "ğŸ“ Archivo: scripts/quality-gate.cjs"
          echo ""

          if [ -f "scripts/quality-gate.cjs" ]; then
            node scripts/quality-gate.cjs || echo "âš ï¸ Quality Gate detectÃ³ violaciones, pero continuamos el flujo."
          else
            echo "âŒ ERROR: El archivo scripts/quality-gate.cjs no existe o no se encontrÃ³."
            exit 1
          fi

          echo ""
          echo "==============================================="
          echo "âœ… FIN DEL CONTROL DE CALIDAD (QUALITY GATE)"
          echo "==============================================="
        continue-on-error: true

      # 9ï¸âƒ£ Subir artefactos (Excel + ZIP + capturas)
      - name: ğŸ“¤ Subir artefactos finales
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: AuditorÃ­a-WCAG-${{ github.run_number }}
          path: |
            auditorias/Informe-*.xlsx
            auditorias/Informe-WCAG-*.zip
            auditorias/*-evidencias/**
          retention-days: 30

      # ğŸ”Ÿ Resumen final
      - name: âœ… Resumen de ejecuciÃ³n
        if: always()
        run: |
          echo "ğŸŒ Sitio auditado: $SITE_URL"
          echo "ğŸ“Š Informe Excel y ZIP subidos como artefactos"
          echo "ğŸš¦ Umbrales Quality Gate: Critical <= $CRITICAL_MAX, Serious <= $SERIOUS_MAX"
          echo "â™¿ AuditorÃ­a finalizada correctamente."
