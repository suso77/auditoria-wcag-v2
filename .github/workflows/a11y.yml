name: ‚ôø Auditor√≠a de Accesibilidad ‚Äì Il√∫mina Audit IAAP PRO
run-name: "‚ôø Auditor√≠a WCAG (${{ github.event.inputs.site_url || 'default' }})"

on:
  workflow_dispatch:
    inputs:
      site_url:
        description: "URL base del sitio a auditar"
        required: false
        default: "https://www.hiexperience.es"
  push:
    branches: [ main, master, principal ]
  pull_request:

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  a11y:
    runs-on: ubuntu-latest
    timeout-minutes: 180   # ‚è±Ô∏è m√°s margen para auditor√≠as grandes

    env:
      SITE_URL: ${{ github.event.inputs.site_url || vars.SITE_URL || 'https://www.hiexperience.es' }}
      BUILD_DATE: ${{ github.run_id }}-${{ github.run_number }}
      TZ: Europe/Madrid
      LANG: es
      NODE_ENV: development
      NODE_OPTIONS: "--max-old-space-size=4096 --no-warnings"
      MAX_URLS: 80
      MAX_DEPTH: 5
      CRAWL_DELAY: 1000
      CYPRESS_screenshotsFolder: auditorias/capturas
      CYPRESS_video: false
      CYPRESS_screenshotOnRunFailure: true
      PUPPETEER_EXECUTABLE_PATH: /usr/bin/google-chrome
      CHROME_BIN: /usr/bin/google-chrome
      CHROME_PATH: /usr/bin/google-chrome
      CI: true

    steps:
      # ======================================================
      # üß© Repositorio y Node.js
      # ======================================================
      - name: üß© Checkout del repositorio
        uses: actions/checkout@v4

      - name: ‚öôÔ∏è Configurar Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "24"
          cache: "npm"

      # ======================================================
      # üåê Verificar que el sitio responde antes de auditar
      # ======================================================
      - name: üîç Verificar disponibilidad del sitio
        run: |
          echo "üîé Verificando que $SITE_URL responde correctamente..."
          STATUS=$(curl -o /dev/null -s -w "%{http_code}" -L "$SITE_URL")
          if [ "$STATUS" != "200" ]; then
            echo "‚ùå El sitio no respondi√≥ con HTTP 200 (recibido: $STATUS)"
            exit 1
          fi
          echo "‚úÖ Sitio accesible (HTTP 200 OK)."

      # ======================================================
      # üß† Configurar entorno Chrome Headless (instalaci√≥n robusta)
      # ======================================================
      - name: üß† Configurar entorno Chrome Headless
        run: |
          sudo apt-get update && sudo apt-get install -y google-chrome-stable
          export PUPPETEER_SKIP_DOWNLOAD=true
          echo "CHROME_BIN=$(which google-chrome)" >> $GITHUB_ENV
          echo "CHROME_PATH=$(which google-chrome)" >> $GITHUB_ENV
          echo "‚úÖ Chrome instalado y disponible en: $(which google-chrome)"

      # ======================================================
      # üì¶ Instalar dependencias IAAP PRO
      # ======================================================
      - name: üì¶ Instalar dependencias IAAP PRO
        run: |
          echo "üì¶ Instalando dependencias IAAP PRO..."
          npm ci --include=dev || npm install --include=dev
          npm install puppeteer
          npm install --save-dev cypress cypress-axe cypress-real-events @bahmutov/cypress-esbuild-preprocessor esbuild pa11y fs-extra exceljs json2csv
          npx cypress verify
          mkdir -p scripts auditorias/{capturas,auditoria-sitemap,auditoria-interactiva,reportes} public/auditorias
          [ ! -f scripts/urls.json ] && echo '[]' > scripts/urls.json
          echo "‚úÖ Entorno IAAP PRO preparado correctamente."

      # ======================================================
      # üßπ Limpieza previa
      # ======================================================
      - name: üßπ Limpiar resultados anteriores
        run: |
          rm -rf auditorias/* public/* || true
          mkdir -p auditorias/{capturas,auditoria-sitemap,auditoria-interactiva,reportes} public/auditorias
          echo "üßπ Carpetas de auditor√≠a limpias."

      # ======================================================
      # üåç Rastreo del sitio web (IAAP PRO Crawler)
      # ======================================================
      - name: üåç Rastreo autom√°tico IAAP PRO
        timeout-minutes: 30
        run: |
          echo "::group::üåç Rastreo IAAP PRO"
          npm run crawl:auto || echo "‚ö†Ô∏è Rastreo autom√°tico fallido, usando fallback..."
          npm run validate:urls || echo "‚ö†Ô∏è Validaci√≥n no cr√≠tica"
          echo "::endgroup::"
        env:
          SITE_URL: ${{ env.SITE_URL }}
          MAX_URLS: ${{ env.MAX_URLS }}
          MAX_DEPTH: ${{ env.MAX_DEPTH }}
          LANG: ${{ env.LANG }}

      # ======================================================
      # üßæ Verificar URLs generadas
      # ======================================================
      - name: üßæ Verificar URLs generadas
        run: |
          if [ ! -s scripts/urls.json ]; then
            echo "‚ùå No se gener√≥ scripts/urls.json o est√° vac√≠o"
            exit 1
          fi
          echo "‚úÖ scripts/urls.json contiene URLs v√°lidas."

      # ======================================================
      # ‚ôø Auditor√≠as h√≠bridas (axe-core + Pa11y)
      # ======================================================
      - name: ‚ôø Auditor√≠a WCAG ‚Äì Sitemap H√≠brido
        uses: cypress-io/github-action@v6
        continue-on-error: true
        with:
          command: >
            npx cypress run --e2e --browser chrome --headless
            --config-file cypress.config.mjs
            --spec "cypress/e2e/accesibilidad-sitemap-hibrido.cy.js"
        env:
          CYPRESS_baseUrl: ${{ env.SITE_URL }}

      - name: ‚ôø Auditor√≠a WCAG ‚Äì Interactiva H√≠brida
        uses: cypress-io/github-action@v6
        continue-on-error: true
        with:
          command: >
            npx cypress run --e2e --browser chrome --headless
            --config-file cypress.config.mjs
            --spec "cypress/e2e/accesibilidad-interactiva-hibrida.cy.js"
        env:
          CYPRESS_baseUrl: ${{ env.SITE_URL }}

      # ======================================================
      # üìÅ Crear estructura base de auditor√≠as (garantizado)
      # ======================================================
      - name: üìÅ Crear estructura base de auditor√≠as
        if: always()
        run: |
          mkdir -p auditorias/{capturas,auditoria-sitemap,auditoria-interactiva,reportes}
          echo "‚úÖ Carpetas base creadas."

      # ======================================================
      # ‚ôø Exportar revisiones manuales y combinar resultados
      # ======================================================
      - name: ‚ôø IAAP PRO ‚Äî Exportar revisiones manuales (needs_review)
        if: always()
        run: |
          echo "::group::‚ôø Exportando revisiones manuales..."
          node scripts/export-needs-review.mjs || echo "‚ö†Ô∏è No se encontraron revisiones manuales."
          echo "::endgroup::"

      - name: ‚ôø IAAP PRO ‚Äî Combinar resultados (axe + Pa11y)
        if: always()
        run: |
          echo "::group::‚ôø Fusi√≥n completa IAAP PRO..."
          node scripts/merge-auditorias.mjs || echo "‚ö†Ô∏è Merge IAAP no cr√≠tico."
          echo "::endgroup::"

      # ======================================================
      # üìä Exportar informes finales
      # ======================================================
      - name: ‚ôø IAAP PRO ‚Äî Exportar informes XLSX / CSV / PDF / HTML
        if: always()
        run: |
          echo "::group::üìä Exportando informes IAAP PRO..."
          mkdir -p auditorias/reportes
          if [ -f auditorias/reportes/merged-results.json ]; then
            node scripts/export-to-xlsx.mjs || echo "‚ö†Ô∏è XLSX no cr√≠tico."
            node scripts/export-to-csv.mjs || echo "‚ö†Ô∏è CSV no cr√≠tico."
            node scripts/export-to-pdf.mjs || echo "‚ö†Ô∏è PDF no cr√≠tico."
            node scripts/generate-dashboard-html.mjs "${{ env.BUILD_DATE }}" || echo "‚ö†Ô∏è Dashboard no cr√≠tico."
          else
            echo "‚ö†Ô∏è No hay merged-results.json, se omite exportaci√≥n."
          fi
          echo "::endgroup::"

      # ======================================================
      # üßæ Generar resumen ejecutivo IAAP PRO
      # ======================================================
      - name: üßæ IAAP PRO ‚Äî Generar resumen ejecutivo Markdown
        if: always()
        run: |
          echo "::group::üßæ Generando resumen ejecutivo IAAP PRO..."
          if [ -f auditorias/reportes/merged-results.json ]; then
            node scripts/generate-summary.mjs auditorias/reportes/merged-results.json || echo "‚ö†Ô∏è No se pudo generar Resumen-WCAG.md"
          else
            echo "‚ö†Ô∏è No se encontr√≥ merged-results.json, se omite generaci√≥n del resumen."
          fi
          echo "::endgroup::"

      # ======================================================
      # üîç Verificar integridad del pipeline IAAP PRO
      # ======================================================
      - name: üîç Verificar pipeline IAAP PRO
        if: always()
        run: |
          echo "::group::üîç Verificando pipeline IAAP PRO..."
          node scripts/verify-pipeline.mjs || echo "‚ö†Ô∏è Verificaci√≥n con advertencias."
          echo "::endgroup::"

      # ======================================================
      # üì¶ Crear ZIP y subir artefactos
      # ======================================================
      - name: üì¶ Crear y subir ZIP IAAP PRO completo
        if: always()
        run: |
          ZIP_NAME="IAAP-PRO-${{ env.BUILD_DATE }}.zip"
          ZIP_PATH="auditorias/${ZIP_NAME}"
          zip -r "${ZIP_PATH}" auditorias/* || true
          echo "‚úÖ ZIP IAAP PRO generado: ${ZIP_PATH}"

      - name: üì§ Subir artefactos IAAP PRO (ZIP + XLSX + CSV + PDF + MD)
        uses: actions/upload-artifact@v4
        with:
          name: "IAAP-PRO-${{ github.run_number }}"
          path: |
            auditorias/IAAP-PRO-*.zip
            auditorias/reportes/*.xlsx
            auditorias/reportes/*.csv
            auditorias/reportes/*.pdf
            auditorias/reportes/*.md
            auditorias/Resumen-WCAG.md
          retention-days: 30

      # ======================================================
      # üöÄ Publicar Dashboard en GitHub Pages
      # ======================================================
      - name: üöÄ Publicar Dashboard en GitHub Pages
        if: always() && hashFiles('auditorias/reportes/merged-results.json') != ''
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./public
          publish_branch: gh-pages
          keep_files: true
          full_commit_message: |
            üöÄ Publicaci√≥n autom√°tica IAAP PRO v5.6.3
            - Fecha: ${{ github.event.head_commit.timestamp }}
            - Run ID: ${{ github.run_id }}
            - Build Date: ${{ env.BUILD_DATE }}
