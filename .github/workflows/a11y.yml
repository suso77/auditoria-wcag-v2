name: â™¿ AuditorÃ­a de Accesibilidad â€“ IlÃºmina Audit IAAP PRO
run-name: "â™¿ AuditorÃ­a WCAG (${{ github.event.inputs.site_url || 'default' }})"

on:
  workflow_dispatch:
    inputs:
      site_url:
        description: "URL base del sitio a auditar"
        required: false
        default: "https://www.hiexperience.es"
  push:
    branches: [ main, master, principal ]
  pull_request:

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  a11y:
    runs-on: ubuntu-latest
    timeout-minutes: 90
    env:
      SITE_URL: ${{ github.event.inputs.site_url || vars.SITE_URL || 'https://www.hiexperience.es' }}
      BUILD_DATE: ${{ github.run_id }}-${{ github.run_number }}
      TZ: Europe/Madrid
      NODE_ENV: production
      NODE_OPTIONS: "--max-old-space-size=4096 --no-warnings"
      CYPRESS_screenshotsFolder: auditorias/capturas
      CYPRESS_video: false
      CYPRESS_screenshotOnRunFailure: true
      PUPPETEER_EXECUTABLE_PATH: /usr/bin/google-chrome
      CI: true

    steps:
      # =====================================================
      # ðŸ§© Setup base
      # =====================================================
      - name: ðŸ§© Checkout del repositorio
        uses: actions/checkout@v4

      - name: âš™ï¸ Configurar Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: ðŸ§  Cachear dependencias pesadas (Cypress + Puppeteer)
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/Cypress
            ~/.cache/puppeteer
          key: ${{ runner.os }}-a11y-v4.13-${{ hashFiles('package-lock.json') }}

      # =====================================================
      # ðŸ“¦ InstalaciÃ³n tolerante
      # =====================================================
      - name: ðŸ“¦ Instalar dependencias
        run: |
          echo "ðŸ“¦ Instalando dependencias..."
          set +e
          npm ci --include=dev || npm install --include=dev
          npm rebuild || true
          mkdir -p scripts auditorias/{capturas,auditoria-sitemap,auditoria-interactiva,reportes} public/auditorias
          [ ! -f scripts/urls.json ] && echo "[]" > scripts/urls.json
          echo "âœ… Dependencias instaladas correctamente."

      # =====================================================
      # ðŸ©¹ Fix de Cypress para entorno CI
      # =====================================================
      - name: ðŸ©¹ Verificar e instalar Cypress
        run: |
          echo "ðŸ©¹ Verificando Cypress..."
          npx cypress verify || (echo "âš™ï¸ Instalando Cypress manualmente..." && npm install cypress@15.6.0 --save-dev)
          echo "âœ… Cypress listo para ejecutar."

      # =====================================================
      # â™»ï¸ Limpieza previa
      # =====================================================
      - name: ðŸ§¹ Limpiar resultados anteriores
        run: |
          rm -rf auditorias/* public/* || true
          mkdir -p auditorias/{capturas,auditoria-sitemap,auditoria-interactiva,reportes} public/auditorias
          echo "ðŸ§¹ Carpetas listas."

      # =====================================================
      # ðŸŒ Rastreo + ValidaciÃ³n
      # =====================================================
      - name: ðŸŒ Rastreo automÃ¡tico IAAP PRO (v4.13.1)
        timeout-minutes: 30
        run: |
          echo "::group::ðŸŒ Rastreo IAAP PRO"
          npm run crawl:auto || echo "âš ï¸ Rastreo automÃ¡tico fallido, intentando fallback..."
          npm run validate:urls || echo "âš ï¸ ValidaciÃ³n no crÃ­tica"
          echo "::endgroup::"
        env:
          SITE_URL: ${{ env.SITE_URL }}

      # =====================================================
      # ðŸ§ª Validar configuraciÃ³n de Cypress antes de auditorÃ­as
      # =====================================================
      - name: ðŸ§ª Validar entorno Cypress
        run: |
          echo "ðŸ” Verificando entorno de Cypress y configuraciÃ³n..."
          if [ ! -f "cypress.config.cjs" ]; then
            echo "âŒ ERROR: No se encuentra cypress.config.cjs en el repositorio."
            exit 1
          fi

          echo "ðŸ“„ Validando cypress.config.cjs..."
          node -e "require('./cypress.config.cjs'); console.log('âœ… ConfiguraciÃ³n Cypress vÃ¡lida.');"

          echo "ðŸ“¦ Verificando mÃ³dulo local de Cypress..."
          if [ ! -d "node_modules/cypress" ]; then
            echo "âš™ï¸ MÃ³dulo local de Cypress no encontrado. Instalando..."
            npm install cypress@15.6.0 --save-dev
          fi

          echo "ðŸ”¢ VersiÃ³n de Cypress:"
          npx cypress version

          echo "âœ… Entorno Cypress verificado correctamente."

      # =====================================================
      # â™¿ AuditorÃ­as principales
      # =====================================================
      - name: â™¿ AuditorÃ­a WCAG â€“ Sitemap
        uses: cypress-io/github-action@v6
        continue-on-error: true
        with:
          command: >
            npx cypress run --e2e --browser chrome --headless
            --config-file cypress.config.cjs
            --spec "cypress/e2e/accesibilidad-sitemap.cy.js"
        env:
          CYPRESS_baseUrl: ${{ env.SITE_URL }}

      - name: ðŸ“¦ Guardar resultados del Sitemap
        run: |
          mkdir -p auditorias/auditoria-sitemap
          cp -r cypress/results/* auditorias/auditoria-sitemap/ 2>/dev/null || true

      - name: â™¿ AuditorÃ­a WCAG â€“ Interactiva
        uses: cypress-io/github-action@v6
        continue-on-error: true
        with:
          command: >
            npx cypress run --e2e --browser chrome --headless
            --config-file cypress.config.cjs
            --spec "cypress/e2e/accesibilidad-interactiva.cy.js"
        env:
          CYPRESS_baseUrl: ${{ env.SITE_URL }}

      - name: ðŸ“¦ Guardar resultados de la Interactiva
        run: |
          mkdir -p auditorias/auditoria-interactiva
          cp -r cypress/results/* auditorias/auditoria-interactiva/ 2>/dev/null || true

      # =====================================================
      # ðŸ§© MERGE + EXPORTACIÃ“N IAAP PRO
      # =====================================================
      - name: â™¿ IAAP PRO â€” Combinar y exportar informes
        if: always()
        run: |
          echo "::group::â™¿ Combinando resultados IAAP PRO..."
          node scripts/merge-auditorias.mjs || echo "âš ï¸ Merge IAAP no crÃ­tico."
          echo "::endgroup::"

          if [ -f auditorias/reportes/merged-results.json ]; then
            echo "::group::ðŸ“Š Exportando informes IAAP PRO..."
            mkdir -p auditorias/reportes
            node scripts/export-to-xlsx.mjs auditorias/reportes/merged-results.json || echo "âš ï¸ XLSX no crÃ­tico."
            node scripts/export-to-csv.mjs auditorias/reportes/merged-results.json || echo "âš ï¸ CSV no crÃ­tico."
            node scripts/export-to-pdf.mjs auditorias/reportes/merged-results.json || echo "âš ï¸ PDF no crÃ­tico."
            node scripts/generate-summary.mjs auditorias/reportes/merged-results.json > auditorias/reportes/merged-summary.md || echo "âš ï¸ Summary no crÃ­tico."
            echo "::endgroup::"
          else
            echo "âš ï¸ No hay merged-results.json, saltando exportaciÃ³n."
          fi

          echo "âœ… Informes IAAP PRO generados correctamente:"
          ls -lh auditorias/reportes || true

      # =====================================================
      # ðŸŒ Dashboard + Artefactos + PublicaciÃ³n
      # =====================================================
      - name: ðŸŒ Generar Dashboard IAAP PRO
        run: |
          echo "::group::ðŸŒ Generando dashboard IAAP PRO..."
          BUILD_PATH="public/auditorias/${BUILD_DATE}"
          REPORTES_PATH="auditorias/reportes"
          mkdir -p "${BUILD_PATH}"
          cp -r "${REPORTES_PATH}"/* "${BUILD_PATH}/" 2>/dev/null || true
          cp -r auditorias/*.pdf auditorias/*.xlsx auditorias/*.zip auditorias/*.csv auditorias/*.md "${BUILD_PATH}/" 2>/dev/null || true
          if [ -d "auditorias/capturas" ]; then
            mkdir -p "${BUILD_PATH}/capturas"
            cp -r auditorias/capturas/**/*.png "${BUILD_PATH}/capturas/" 2>/dev/null || true
          fi
          echo "::endgroup::"
          echo "âœ… Dashboard IAAP PRO generado correctamente en ${BUILD_PATH}/"

      # =====================================================
      # ðŸ“¦ Comprimir y subir auditorÃ­a completa (ZIP IAAP PRO)
      # =====================================================
      - name: ðŸ“¦ Crear paquete ZIP IAAP PRO completo
        if: always()
        run: |
          echo "::group::ðŸ“¦ Empaquetando auditorÃ­a IAAP PRO..."
          ZIP_NAME="IAAP-PRO-${{ env.BUILD_DATE }}.zip"
          ZIP_PATH="auditorias/${ZIP_NAME}"
          mkdir -p auditorias
          zip -r "${ZIP_PATH}" auditorias/reportes auditorias/capturas auditorias/*.pdf auditorias/*.xlsx auditorias/*.csv auditorias/*.md 2>/dev/null || true
          echo "::endgroup::"
          echo "âœ… ZIP IAAP PRO generado: ${ZIP_PATH}"
          ls -lh "${ZIP_PATH}" || true

      - name: ðŸ“¤ Subir ZIP IAAP PRO como artefacto
        uses: actions/upload-artifact@v4
        with:
          name: "IAAP-PRO-${{ github.run_number }}-full"
          path: auditorias/IAAP-PRO-*.zip
          retention-days: 30

      - name: ðŸš€ Publicar en GitHub Pages
        if: success() && (hashFiles('auditorias/reportes/merged-results.json') != '')
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./public
          publish_branch: gh-pages
          keep_files: true
          full_commit_message: |
            ðŸš€ PublicaciÃ³n automÃ¡tica IAAP PRO v4.13.1
            - Fecha: ${{ github.event.head_commit.timestamp }}
            - Run ID: ${{ github.run_id }}
            - Build Date: ${{ env.BUILD_DATE }}

