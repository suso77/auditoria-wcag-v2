name: â™¿ AuditorÃ­a de Accesibilidad â€“ IlÃºmina Audit IAAP PRO v7.0
run-name: "â™¿ AuditorÃ­a WCAG (${{ github.event.inputs.site_url || 'default' }})"

on:
  workflow_dispatch:
    inputs:
      site_url:
        description: "URL base del sitio a auditar"
        required: false
        default: "https://www.hiexperience.es"
  push:
    branches: [ main, master, principal ]
  pull_request:

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  a11y:
    runs-on: ubuntu-latest
    timeout-minutes: 180

    env:
      SITE_URL: ${{ github.event.inputs.site_url || vars.SITE_URL || 'https://www.hiexperience.es' }}
      BUILD_DATE: ${{ github.run_id }}-${{ github.run_number }}
      TZ: Europe/Madrid
      LANG: es
      NODE_ENV: development
      NODE_OPTIONS: "--max-old-space-size=4096 --no-warnings"
      MAX_URLS: 80
      MAX_DEPTH: 5
      CRAWL_DELAY: 1000
      CYPRESS_screenshotsFolder: auditorias/capturas
      CYPRESS_video: false
      CYPRESS_screenshotOnRunFailure: true
      PUPPETEER_EXECUTABLE_PATH: /usr/bin/google-chrome
      CHROME_BIN: /usr/bin/google-chrome
      CHROME_PATH: /usr/bin/google-chrome
      CI: true

    steps:
      # ======================================================
      # ğŸ§© Repositorio y Node.js
      # ======================================================
      - name: ğŸ§© Checkout del repositorio
        uses: actions/checkout@v4

      - name: âš™ï¸ Configurar Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "24"
          cache: "npm"

      # ======================================================
      # ğŸŒ Verificar disponibilidad del sitio
      # ======================================================
      - name: ğŸ” Verificar disponibilidad del sitio
        run: |
          echo "ğŸ” Verificando que $SITE_URL responde correctamente..."
          STATUS=$(curl -o /dev/null -s -w "%{http_code}" -L "$SITE_URL")
          if [ "$STATUS" != "200" ]; then
            echo "âŒ El sitio no respondiÃ³ con HTTP 200 (recibido: $STATUS)"
            exit 1
          fi
          echo "âœ… Sitio accesible (HTTP 200 OK)."

      # ======================================================
      # ğŸ§  Instalar Chrome Headless
      # ======================================================
      - name: ğŸ§  Instalar entorno Chrome Headless
        run: |
          sudo apt-get update && sudo apt-get install -y google-chrome-stable
          export PUPPETEER_SKIP_DOWNLOAD=true
          echo "CHROME_BIN=$(which google-chrome)" >> $GITHUB_ENV
          echo "CHROME_PATH=$(which google-chrome)" >> $GITHUB_ENV
          echo "âœ… Chrome disponible en: $(which google-chrome)"

      # ======================================================
      # ğŸ“¦ Instalar dependencias IAAP PRO
      # ======================================================
      - name: ğŸ“¦ Instalar dependencias IAAP PRO
        run: |
          echo "ğŸ“¦ Instalando dependencias IAAP PRO..."
          npm ci --include=dev || npm install --include=dev || true
          npm install puppeteer --silent || true
          npm install --save-dev cypress cypress-axe cypress-real-events @bahmutov/cypress-esbuild-preprocessor esbuild pa11y fs-extra exceljs json2csv chalk xlsx --silent || true
          npx cypress verify || echo "âš ï¸ Cypress verificado con advertencias (no crÃ­tico)."
          mkdir -p scripts auditorias/{capturas,auditoria-sitemap,auditoria-interactiva,reportes} public/auditorias
          [ ! -f scripts/urls.json ] && echo '[]' > scripts/urls.json
          echo "âœ… Entorno IAAP PRO preparado correctamente."

      # ======================================================
      # âœ… Verificar dependencias IAAP PRO
      # ======================================================
      - name: ğŸ” Verificar dependencias IAAP PRO
        run: |
          echo "ğŸ” Listado de dependencias IAAP PRO:"
          npm ls --depth=0 || true
          echo "ğŸ” Verificando mÃ³dulos crÃ­ticos..."
          node -e "require.resolve('xlsx'); console.log('âœ… XLSX detectado correctamente')"
          node -e "require.resolve('cypress'); console.log('âœ… Cypress detectado correctamente')"
          node -e "require.resolve('pa11y'); console.log('âœ… Pa11y detectado correctamente')"
          node -e "require.resolve('puppeteer'); console.log('âœ… Puppeteer detectado correctamente')"
          echo "âœ… Dependencias IAAP PRO verificadas con Ã©xito."

      # ======================================================
      # ğŸ§¹ Limpieza previa
      # ======================================================
      - name: ğŸ§¹ Limpieza resultados anteriores
        run: |
          rm -rf auditorias/* public/* || true
          mkdir -p auditorias/{capturas,auditoria-sitemap,auditoria-interactiva,reportes} public/auditorias
          echo "ğŸ§¹ Limpieza completada."

      # ======================================================
      # ğŸŒ Rastreo inteligente IAAP PRO (Smart Crawler)
      # ======================================================
      - name: ğŸŒ Rastreo IAAP PRO (Smart Crawler v7.0)
        timeout-minutes: 25
        run: |
          echo "::group::ğŸŒ Rastreo IAAP PRO Smart v7.0"
          export LANG_FILTER="/es/"
          export MAX_URLS=80
          export MAX_DEPTH=5
          echo "ğŸ”§ SITE_URL=$SITE_URL"
          echo "ğŸ”§ LANG_FILTER=$LANG_FILTER"
          echo "ğŸ”§ MAX_URLS=$MAX_URLS"
          echo "ğŸ”§ MAX_DEPTH=$MAX_DEPTH"
          
          npm run crawl:smart || echo "âš ï¸ Rastreo Smart fallido, intentando fallback estÃ¡ndar..."
          npm run validate:urls || echo "âš ï¸ ValidaciÃ³n no crÃ­tica"
          echo "::endgroup::"

      # ======================================================
      # ğŸ§¾ Verificar URLs generadas
      # ======================================================
      - name: ğŸ§¾ Verificar URLs generadas
        run: |
          if [ ! -s scripts/urls.json ]; then
            echo "âŒ No se generÃ³ scripts/urls.json o estÃ¡ vacÃ­o."
            exit 1
          fi
          COUNT=$(jq length scripts/urls.json)
          FILTERED=$(jq '[.[] | select(.url | contains("/es/"))] | length' scripts/urls.json)
          if [ "$COUNT" -gt 80 ]; then
            echo "âŒ Se superÃ³ el lÃ­mite de 80 URLs ($COUNT detectadas)."
            exit 1
          fi
          if [ "$FILTERED" -eq 0 ]; then
            echo "âŒ No se detectaron URLs que contengan /es/."
            exit 1
          fi
          echo "âœ… scripts/urls.json contiene $FILTERED URLs vÃ¡lidas con /es/."

      # ======================================================
      # ğŸ” VerificaciÃ³n de scripts Cypress
      # ======================================================
      - name: ğŸ” Verificar que Sitemap no ejecuta Pa11y
        run: |
          if grep -Eiq "pa11y" cypress/e2e/accesibilidad-sitemap-hibrido.cy.js; then
            echo "âŒ Error: El archivo Sitemap contiene referencias a Pa11y."
            exit 1
          fi
          echo "âœ… OK: Sitemap usa solo axe-core."

      # ======================================================
      # â™¿ AuditorÃ­as WCAG IAAP PRO
      # ======================================================
      - name: ğŸ§¾ Verificar existencia de specs
        run: |
          for file in cypress/e2e/accesibilidad-sitemap-hibrido.cy.js cypress/e2e/accesibilidad-interactiva-hibrida.cy.js; do
            if [ ! -f "$file" ]; then
              echo "âŒ Archivo de test no encontrado: $file"
              exit 1
            fi
            echo "âœ… Archivo detectado: $file"
          done

      - name: â™¿ AuditorÃ­a WCAG â€“ Sitemap (solo axe-core)
        uses: cypress-io/github-action@v6
        with:
          command: >
            npx cypress run --browser chrome --headless
            --spec cypress/e2e/accesibilidad-sitemap-hibrido.cy.js
        env:
          CYPRESS_baseUrl: ${{ env.SITE_URL }}
          AUDIT_ENGINE: axe-core
          AUDIT_SOURCE: sitemap

      - name: â™¿ AuditorÃ­a WCAG â€“ Interactiva (Pa11y + fallback axe-core)
        uses: cypress-io/github-action@v6
        continue-on-error: true
        with:
          command: >
            npx cypress run --browser chrome --headless
            --spec cypress/e2e/accesibilidad-interactiva-hibrida.cy.js
        env:
          CYPRESS_baseUrl: ${{ env.SITE_URL }}
          AUDIT_ENGINE: pa11y
          AUDIT_FALLBACK: axe-core
          AUDIT_SOURCE: interactiva

      # ======================================================
      # â™¿ Merge + Metadatos
      # ======================================================
      - name: â™¿ Fusionar resultados (merge-auditorias v7.0)
        run: |
          echo "â™¿ Fusionando auditorÃ­as IAAP PRO..."
          node scripts/merge-auditorias.mjs
          echo "âœ… Resultados fusionados correctamente."

      - name: ğŸ§© Verificar integridad de metadatos (verify-metadata v7.0)
        run: |
          echo "ğŸ” Validando metadatos IAAP PRO..."
          node scripts/verify-metadata.mjs

      # ======================================================
      # ğŸ“Š Exportar informes IAAP PRO (Markdown + XLSX + HTML)
      # ======================================================
      - name: ğŸ“Š Exportar informes IAAP PRO
        if: always()
        run: |
          if [ -f auditorias/reportes/merged-results.json ]; then
            echo "ğŸ“Š Generando informes IAAP PRO..."
            node scripts/generate-summary.mjs
            echo "âœ… Informes generados correctamente."
          else
            echo "âš ï¸ No se encontrÃ³ merged-results.json, se omite exportaciÃ³n."
          fi

      # ======================================================
      # ğŸ” VerificaciÃ³n final
      # ======================================================
      - name: ğŸ” Verificar pipeline IAAP PRO
        if: always()
        run: node scripts/verify-pipeline.mjs || echo "âš ï¸ Advertencias menores detectadas."

      # ======================================================
      # ğŸ“¦ ZIP y artefactos
      # ======================================================
      - name: ğŸ“¦ Comprimir resultados IAAP PRO
        if: always()
        run: |
          ZIP_NAME="IAAP-PRO-v7.0-${{ env.BUILD_DATE }}.zip"
          zip -r "auditorias/${ZIP_NAME}" auditorias/* || true
          echo "ğŸ“¦ Archivo comprimido: $ZIP_NAME"

      - name: ğŸ“¤ Subir artefactos IAAP PRO
        uses: actions/upload-artifact@v4
        with:
          name: "IAAP-PRO-v7.0-${{ github.run_number }}"
          path: |
            auditorias/IAAP-PRO-v7.0-*.zip
            auditorias/Resumen-WCAG.*
            auditorias/reportes/*.xlsx
            auditorias/reportes/*.json
          retention-days: 30

      # ======================================================
      # ğŸš€ Publicar Dashboard IAAP PRO
      # ======================================================
      - name: ğŸš€ Publicar Dashboard IAAP PRO v7.0
        if: always() && hashFiles('auditorias/reportes/merged-results.json') != ''
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./public
          publish_branch: gh-pages
          keep_files: true
          full_commit_message: |
            ğŸš€ PublicaciÃ³n automÃ¡tica IAAP PRO v7.0
            - Fecha: ${{ github.event.head_commit.timestamp }}
            - Run ID: ${{ github.run_id }}
            - Build Date: ${{ env.BUILD_DATE }}
