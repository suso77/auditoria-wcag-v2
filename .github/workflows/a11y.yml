name: ‚ôø Auditor√≠a de Accesibilidad ‚Äì Il√∫mina Audit IAAP PRO
run-name: "‚ôø Auditor√≠a WCAG (${{ github.event.inputs.site_url || 'default' }})"

on:
  workflow_dispatch:
    inputs:
      site_url:
        description: "URL base del sitio a auditar"
        required: false
        default: "https://www.hiexperience.es"
  push:
    branches: [ main, master, principal ]
  pull_request:

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  a11y:
    runs-on: ubuntu-latest
    timeout-minutes: 90
    env:
      SITE_URL: ${{ github.event.inputs.site_url || vars.SITE_URL || 'https://www.hiexperience.es' }}
      BUILD_DATE: ${{ github.run_id }}-${{ github.run_number }}
      TZ: Europe/Madrid
      NODE_ENV: production
      NODE_OPTIONS: "--max-old-space-size=4096 --no-warnings"
      CYPRESS_screenshotsFolder: auditorias/capturas
      CYPRESS_video: false
      CYPRESS_screenshotOnRunFailure: true

    steps:
      # =====================================================
      # üß© Setup base
      # =====================================================
      - name: üß© Checkout del repositorio
        uses: actions/checkout@v4

      - name: ‚öôÔ∏è Configurar Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: üß† Cachear dependencias pesadas
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/Cypress
            ~/.cache/puppeteer
          key: ${{ runner.os }}-a11y-v4.1-${{ hashFiles('package-lock.json') }}

      # =====================================================
      # üì¶ Instalaci√≥n tolerante
      # =====================================================
      - name: üì¶ Instalar dependencias (modo estable)
        run: |
          echo "üì¶ Instalando dependencias..."
          set +e
          npm ci --include=dev || npm install --include=dev
          npm rebuild || true
          mkdir -p scripts auditorias/capturas auditorias/logs
          [ ! -f scripts/urls.json ] && echo "[]" > scripts/urls.json
          echo "‚úÖ Dependencias instaladas correctamente."

      # =====================================================
      # üßπ Limpieza previa
      # =====================================================
      - name: üßπ Limpiar resultados anteriores
        run: |
          rm -rf auditorias/* public/* || true
          mkdir -p auditorias/capturas auditorias/auditoria-sitemap auditorias/auditoria-interactiva public/auditorias
          [ ! -f scripts/urls.json ] && echo "[]" > scripts/urls.json
          echo "üßπ Carpetas de auditor√≠a listas."

      - name: üß™ Verificar instalaci√≥n de Cypress
        run: npx cypress verify || npx cypress install

      # =====================================================
      # üåê Rastreo + Validaci√≥n
      # =====================================================
      - name: üåç Rastreo autom√°tico IAAP PRO (v4.1)
        timeout-minutes: 15
        run: |
          echo "::group::üåç Rastreo inteligente IAAP PRO"
          npm run crawl:auto || echo "‚ö†Ô∏è Rastreo autom√°tico fallido, intentando fallback..."
          npm run validate:urls || echo "‚ö†Ô∏è Validaci√≥n no cr√≠tica"
          echo "::endgroup::"
        env:
          SITE_URL: ${{ env.SITE_URL }}

      # =====================================================
      # ‚ôø Auditor√≠as principales (WCAG + AXE)
      # =====================================================
      - name: ‚ôø Auditor√≠a WCAG ‚Äì Sitemap (v4.1)
        uses: cypress-io/github-action@v6
        continue-on-error: true
        with:
          install-command: npm ci --include=dev || true
          command: >
            npx cypress run --e2e --browser chrome --headless
            --config-file cypress.config.cjs
            --spec cypress/e2e/accesibilidad-sitemap.cy.js
        env:
          CYPRESS_baseUrl: ${{ env.SITE_URL }}

      - name: ‚è±Ô∏è Pausa breve
        run: sleep 10

      - name: ‚ôø Auditor√≠a WCAG ‚Äì Componentes Interactivos (v4.1)
        uses: cypress-io/github-action@v6
        continue-on-error: true
        with:
          install-command: npm ci --include=dev || true
          command: >
            npx cypress run --e2e --browser chrome --headless
            --config-file cypress.config.cjs
            --spec cypress/e2e/accesibilidad-interactiva.cy.js
        env:
          CYPRESS_baseUrl: ${{ env.SITE_URL }}

      # =====================================================
      # üß© Combinaci√≥n + resumen IAAP
      # =====================================================
      - name: üß© Combinar resultados WCAG
        run: |
          echo "::group::‚ôø Combinando resultados..."
          node scripts/merge-results.mjs || echo "‚ö†Ô∏è Merge no cr√≠tico."
          echo "::endgroup::"

      - name: üßæ Generar resumen ejecutivo
        run: |
          LAST_JSON=$(ls -t auditorias/results-merged-*.json 2>/dev/null | head -n1)
          if [ -n "$LAST_JSON" ]; then
            node scripts/generate-summary.mjs "$LAST_JSON" > auditorias/Resumen-WCAG.md
          else
            echo "‚ö†Ô∏è No se gener√≥ resumen (sin resultados)."
          fi

      - name: üìä Exportar Excel IAAP
        run: node scripts/export-to-xlsx.mjs || echo "‚ö†Ô∏è Error exportando Excel IAAP."

      # =====================================================
      # üß± Quality Gate IAAP PRO (v4.1)
      # =====================================================
      - name: üß± Quality Gate IAAP PRO (v4.1)
        run: |
          echo "::group::üß± Evaluando umbrales de calidad IAAP..."
          node -e "
          import fs from 'fs';
          const results = fs.readdirSync('auditorias')
            .filter(f => f.startsWith('results-merged-') && f.endsWith('.json'))
            .map(f => JSON.parse(fs.readFileSync('auditorias/' + f, 'utf8')))
            .flat();
          if (!results.length) { console.log('‚ö†Ô∏è No hay resultados para evaluar.'); process.exit(0); }

          const allViolations = results.flatMap(r => r.violations || []);
          const counts = { critical: 0, serious: 0, moderate: 0, minor: 0 };
          for (const v of allViolations) counts[v.impact] = (counts[v.impact] || 0) + 1;

          const total = allViolations.length;
          const limits = {
            critical: parseInt(process.env.CRITICAL_MAX || '0', 10),
            serious: parseInt(process.env.SERIOUS_MAX || '5', 10),
            moderate: parseInt(process.env.MODERATE_MAX || '9999', 10),
            minor: parseInt(process.env.MINOR_MAX || '9999', 10)
          };

          console.log('üìä Conteo de violaciones:', counts);
          console.log('üö¶ Umbrales configurados:', limits);

          const resumen = [
            '# ‚ôø Quality Gate IAAP PRO v4.1',
            '',
            '## üìã Resultados globales',
            `- Total violaciones: **${total}**`,
            `- Cr√≠ticas: **${counts.critical || 0}** (m√°x ${limits.critical})`,
            `- Graves: **${counts.serious || 0}** (m√°x ${limits.serious})`,
            `- Moderadas: **${counts.moderate || 0}** (m√°x ${limits.moderate})`,
            `- Menores: **${counts.minor || 0}** (m√°x ${limits.minor})`,
            '',
            '---',
            '## üß© Evaluaci√≥n de cumplimiento'
          ];

          const status = {
            critical: counts.critical <= limits.critical,
            serious: counts.serious <= limits.serious,
            moderate: counts.moderate <= limits.moderate,
            minor: counts.minor <= limits.minor
          };

          const passed = Object.values(status).every(Boolean);
          for (const [key, ok] of Object.entries(status)) {
            resumen.push(ok ? `‚úÖ ${key} dentro del l√≠mite` : `‚ùå ${key} supera el l√≠mite permitido`);
          }

          resumen.push('', `### Resultado final: ${passed ? '‚úÖ APROBADO' : '‚ùå RECHAZADO'}`);

          fs.writeFileSync('auditorias/quality-gate.md', resumen.join('\\n'), 'utf8');
          console.log('‚úÖ Quality Gate IAAP PRO generado en auditorias/quality-gate.md');
          if (!passed) process.exit(1);
          " || echo "‚ö†Ô∏è Quality Gate no cr√≠tico"
          echo "::endgroup::"
        env:
          CRITICAL_MAX: 0
          SERIOUS_MAX: 5
          MODERATE_MAX: 9999
          MINOR_MAX: 9999

      # =====================================================
      # üñ®Ô∏è PDF + ZIP consolidado
      # =====================================================
      - name: üß© Instalar Puppeteer estable
        run: npm install puppeteer@23.11.1 --no-save

      - name: üñ®Ô∏è Generar PDF IAAP PRO
        run: node scripts/generate-report.mjs || echo "‚ö†Ô∏è Error generando PDF IAAP."
        env:
          PUPPETEER_EXECUTABLE_PATH: /usr/bin/google-chrome-stable

      - name: üì¶ Generar ZIP consolidado
        run: |
          zip -r auditorias/Informe-WCAG-IAAP.zip auditorias/*.xlsx auditorias/*.pdf auditorias/*.md auditorias/results-merged-*.json || echo "‚ö†Ô∏è ZIP no generado"

      # =====================================================
      # üåê Dashboard IAAP PRO
      # =====================================================
      - name: üåê Generar Dashboard IAAP PRO (v4.1)
        run: |
          echo "::group::üåê Generando dashboard IAAP PRO..."
          mkdir -p public/auditorias/${BUILD_DATE}

          LAST_JSON=$(ls -t auditorias/results-merged-*.json 2>/dev/null | head -n1)
          if [ -z "$LAST_JSON" ]; then
            echo "[]" > public/auditorias/${BUILD_DATE}/resultados.json
          else
            cp "$LAST_JSON" public/auditorias/${BUILD_DATE}/resultados.json
          fi

          cp auditorias/*.pdf auditorias/*.xlsx auditorias/*.zip auditorias/*.md public/auditorias/${BUILD_DATE}/ 2>/dev/null || true

          echo "üìä Generando resumen IAAP..."
          node -e "
          import fs from 'fs';
          const f='public/auditorias/${BUILD_DATE}/resultados.json';
          if(!fs.existsSync(f)){process.exit(0);}
          const data=JSON.parse(fs.readFileSync(f,'utf8'));
          const impacts=data.flatMap(r=>(r.violations||[]).map(v=>v.impact||'sin clasificar'));
          const counts=impacts.reduce((a,i)=>(a[i]=(a[i]||0)+1,a),{});
          const total=Object.values(counts).reduce((a,b)=>a+b,0);
          const html='<ul>'+Object.entries(counts).map(([k,v])=>'<li>'+k+': <strong>'+v+'</strong></li>').join('')+'</ul><p><strong>Total violaciones:</strong> '+total+'</p>';
          fs.writeFileSync('public/auditorias/${BUILD_DATE}/impactos.html',html);
          "

          cat > public/auditorias/${BUILD_DATE}/index.html <<'HTML'
          <!DOCTYPE html>
          <html lang="es">
          <head>
            <meta charset="utf-8" />
            <title>‚ôø Informe de Accesibilidad Digital IAAP PRO</title>
            <meta name="viewport" content="width=device-width, initial-scale=1" />
            <style>
              body { font-family: system-ui, sans-serif; background:#fafafa; color:#222; margin:2em; line-height:1.6; }
              h1,h2 { color:#003366; }
              section { background:#fff; border-radius:12px; padding:1.5em; margin-bottom:2em; box-shadow:0 2px 6px rgba(0,0,0,0.08); }
              a.download { background:#004080; color:#fff; padding:0.8em 1.4em; border-radius:8px; text-decoration:none; margin-right:0.6em; display:inline-block; }
              a.download:hover { background:#002b5e; }
              footer { text-align:center; font-size:0.85em; color:#555; margin-top:3em; }
              ul { list-style:none; padding-left:0; }
              li { margin:0.3em 0; }
              iframe { border:1px solid #ddd; border-radius:8px; }
            </style>
          </head>
          <body>
            <h1>‚ôø Informe de Accesibilidad Digital IAAP PRO</h1>
            <section>
              <h2>üìä Resumen</h2>
              <p><strong>Fecha:</strong> <script>document.write(new Date().toLocaleString('es-ES'))</script></p>
              <div id="resumenIAAP"></div>
            </section>
            <section>
              <h2>üìÑ Informe PDF IAAP</h2>
              <iframe src="Informe-WCAG-IAAP.pdf" width="100%" height="600" title="Informe IAAP"></iframe>
            </section>
            <section>
              <h2>üíæ Descargas</h2>
              <p>
                <a href="Informe-WCAG-IAAP.xlsx" class="download">Excel IAAP</a>
                <a href="Informe-WCAG-IAAP.zip" class="download">ZIP Consolidado</a>
                <a href="Resumen-WCAG.md" class="download">Resumen Markdown</a>
              </p>
            </section>
            <footer>¬© Il√∫mina Audit IAAP ¬∑ 2025</footer>
            <script>
              fetch('impactos.html').then(r=>r.text()).then(html=>{
                document.getElementById('resumenIAAP').innerHTML=html;
              }).catch(()=>{
                document.getElementById('resumenIAAP').innerHTML='<p>‚ö†Ô∏è No se pudo generar resumen IAAP.</p>';
              });
            </script>
          </body>
          </html>
          HTML
          echo "::endgroup::"
          echo "‚úÖ Dashboard IAAP generado correctamente en public/auditorias/${BUILD_DATE}/"

      # =====================================================
      # üì§ Subida + Publicaci√≥n
      # =====================================================
      - name: üì§ Subir artefactos IAAP
        uses: actions/upload-artifact@v4
        with:
          name: "WCAG-IAAP-${{ github.run_number }}"
          path: |
            auditorias/results-merged-*.json
            auditorias/*.pdf
            auditorias/*.xlsx
            auditorias/*.md
            auditorias/*.zip
            auditorias/capturas/**/*.png
          retention-days: 30

      - name: üöÄ Publicar en GitHub Pages
        if: success() && (hashFiles('auditorias/results-merged-*.json') != '')
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./public
          publish_branch: gh-pages
          commit_message: "üöÄ Publicaci√≥n autom√°tica WCAG IAAP PRO v4.1 (${{ github.run_number }})"
