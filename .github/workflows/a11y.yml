name: â™¿ AuditorÃ­a de Accesibilidad â€“ a11y CI

on:
  workflow_dispatch:
    inputs:
      site_url:
        description: "URL base del sitio a auditar"
        required: false
        default: "https://www.hiexperience.es"
  push:
    branches: [ main, master, principal ]
  pull_request:

jobs:
  a11y:
    runs-on: ubuntu-latest

    env:
      SITE_URL: ${{ github.event.inputs.site_url || 'https://www.hiexperience.es' }}
      LC_ALL: C.UTF-8
      LANG: C.UTF-8
      CRITICAL_MAX: 0
      SERIOUS_MAX: 5
      TZ: Europe/Madrid

    steps:
      # 1ï¸âƒ£ Clonar repositorio
      - name: ğŸ§© Checkout del repositorio
        uses: actions/checkout@v4

      # 2ï¸âƒ£ Configurar Node.js
      - name: âš™ï¸ Configurar Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: '**/package-lock.json'

      # 3ï¸âƒ£ Instalar dependencias
      - name: ğŸ“¦ Instalar dependencias
        run: |
          echo "ğŸ“¦ Instalando dependencias..."
          npm ci || npm install
          echo "âœ… Dependencias instaladas correctamente."
          npm list --depth=0 || true

      # 4ï¸âƒ£ Rastreo de URLs
      - name: ğŸŒ Rastreo de URLs con Puppeteer
        run: |
          echo "ğŸŒ Iniciando rastreo de URLs en $SITE_URL"
          npm run crawl:js || echo "âš ï¸ Error menor en rastreo (continuamos)..."
          echo "âœ… Rastreo completado. Archivo: scripts/urls.json"

      # 5ï¸âƒ£ AuditorÃ­a principal (sitemap)
      - name: â™¿ AuditorÃ­a de accesibilidad â€“ Sitemap
        uses: cypress-io/github-action@v6
        with:
          install-command: npm ci
          command: npm run audit:sitemap || echo "âš ï¸ Violaciones detectadas (continuamos para informes)..."
        env:
          SITE_URL: ${{ env.SITE_URL }}

      # 6ï¸âƒ£ AuditorÃ­a interactiva (modales, menÃºs, banners)
      - name: ğŸ§  AuditorÃ­a de accesibilidad â€“ Componentes interactivos
        uses: cypress-io/github-action@v6
        with:
          install-command: npm ci
          command: npm run audit:interactive || echo "âš ï¸ Violaciones detectadas (continuamos para informes)..."
        env:
          SITE_URL: ${{ env.SITE_URL }}

      # 7ï¸âƒ£ Combinar resultados (merge)
      - name: ğŸ§© Combinar resultados de auditorÃ­as
        run: |
          echo "ğŸ”„ Combinando resultados..."
          npm run merge || npm run fix
          echo "âœ… Archivo combinado generado correctamente."

      # 8ï¸âƒ£ Validar integridad del archivo combinado
      - name: ğŸ” Validar archivo combinado
        run: |
          FILE=$(ls auditorias/results-merged-*.json 2>/dev/null | tail -n 1 || true)
          if [ -z "$FILE" ]; then
            echo "âŒ No se encontrÃ³ results-merged.json, intentando regenerar..."
            npm run merge || npm run fix
          elif [ ! -s "$FILE" ]; then
            echo "âš ï¸ Archivo vacÃ­o, intentando reparar..."
            npm run fix || true
          else
            echo "âœ… Archivo vÃ¡lido detectado: $FILE"
          fi

      # 9ï¸âƒ£ Control de calidad (Quality Gate)
      - name: ğŸš¦ Quality Gate â€“ WCAG
        run: |
          echo "==============================================="
          echo "ğŸš¦ INICIO DEL CONTROL DE CALIDAD"
          echo "==============================================="
          npm run quality
          echo "==============================================="
          echo "âœ… FIN DEL CONTROL DE CALIDAD"
          echo "==============================================="
        continue-on-error: true

      # ğŸ”Ÿ Exportar informe Excel + ZIP
      - name: ğŸ“Š Exportar informe Excel + ZIP
        if: always()
        run: |
          echo "ğŸ“„ Generando informe Excel..."
          npm run report
          echo "âœ… Informe Excel generado correctamente."
          echo ""
          echo "ğŸ“‚ Contenido de /auditorias:"
          ls -lh auditorias/ || echo "âš ï¸ Carpeta no encontrada."

      # 11ï¸âƒ£ Subir artefactos
      - name: ğŸ“¤ Subir artefactos finales
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: AuditorÃ­a-WCAG-${{ github.run_number }}
          path: |
            auditorias/results-merged-*.json
            auditorias/quality-report.json
            auditorias/Informe-WCAG.xlsx
            auditorias/Informe-WCAG.zip
            auditorias/*-evidencias/**
          retention-days: 30

      # 12ï¸âƒ£ Resumen final
      - name: âœ… Resumen de ejecuciÃ³n
        if: always()
        run: |
          echo "==============================================="
          echo "â™¿ RESUMEN FINAL DE LA AUDITORÃA"
          echo "==============================================="
          echo "ğŸŒ Sitio auditado: $SITE_URL"
          echo "ğŸ“Š Resultados combinados + informe Excel generados"
          echo "ğŸš¦ Umbrales Quality Gate: Critical <= $CRITICAL_MAX, Serious <= $SERIOUS_MAX"
          echo "âœ… Pipeline finalizado correctamente."
